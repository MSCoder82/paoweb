<!-- Changelog: Unified metrics dashboard, role-based menu, AI assistant integration, and external design system stylesheet. -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>NWW PAO ‚Ä¢ Metrics + Role Menu (One Page)</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="design-system.css">
<style>
  :root{
    --bg: #0e0f1a;
    --card: #15172a;
    --muted: #a2a7c6;
    --txt: #e7ebff;
    --accent1: linear-gradient(135deg,#7c4dff 0%, #00e5ff 100%); /* info kpis */
    --accent2: linear-gradient(135deg,#ff6ec4 0%, #7873f5 100%); /* admin/menu */
    --accent3: linear-gradient(135deg,#f6d365 0%, #fda085 100%); /* goals */
    --accent4: linear-gradient(135deg,#42e695 0%, #3bb2b8 100%); /* staff cards */
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    color:var(--txt);
    background:
      radial-gradient(1200px 600px at 10% -10%, rgba(124,77,255,.25), transparent 60%),
      radial-gradient(1000px 500px at 90% 0%, rgba(0,229,255,.25), transparent 60%),
      radial-gradient(800px 400px at 50% 110%, rgba(255,110,196,.18), transparent 60%),
      var(--bg);
  }
  .shell{max-width:1200px;margin:0 auto;padding:24px}
  .topbar{
    display:flex; gap:12px; align-items:center; justify-content:space-between;
    padding:14px 18px; border:1px solid #2a2d4a; border-radius:14px;
    background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.15));
    backdrop-filter: blur(6px);
  }
  .topbar h1{font-size:18px;letter-spacing:.3px;margin:0;font-weight:800}
  .pill{border:1px solid #2b3157; border-radius:999px; padding:8px 12px; color:var(--muted); background:#0f1225}
  .ghost.small{padding:6px 10px; font-weight:600; background:#10132a; border:1px solid #293055; color:#cbd2ff; border-radius:12px; cursor:pointer}
  .hamburger{
    display:flex; width:40px;height:40px;border-radius:12px;border:1px solid #2a2d4a; background:#0f1224;
    align-items:center;justify-content:center;cursor:pointer;color:#cfe0ff;
  }
  .hamburger svg{width:22px;height:22px}
  .row{display:flex; gap:16px; flex-wrap:wrap}
  .col{flex:1 1 320px}
  .grid{display:grid; gap:14px}
  .grid-2{grid-template-columns:repeat(2, minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3, minmax(0,1fr))}
  .card{background:var(--card); border:1px solid #25294a; border-radius:16px; padding:18px; box-shadow: 0 10px 30px rgba(3,4,10,.35)}
  .card h3{margin:0 0 10px 0; font-size:16px; letter-spacing:.2px}
  .badge{display:inline-flex; align-items:center; gap:8px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.25)); border:1px solid #2a2e50; color:var(--muted); border-radius:999px; padding:6px 10px; font-size:12px}
  .cta,.ghost.btn,.danger{appearance:none; border:none; cursor:pointer; font-weight:700; letter-spacing:.3px; border-radius:12px; padding:10px 14px}
  .cta{ background:var(--accent4); color:#041216 }
  .ghost.btn{ background:#10132a; border:1px solid #293055; color:#cbd2ff }
  .danger{ background: linear-gradient(135deg,#ff6b6b,#f06595); color:#fff}
  .input, select, textarea{width:100%; background:#0f1224; color:var(--txt); border:1px solid #2a2e50; border-radius:12px; padding:10px 12px; font-size:14px}
  label{font-size:12px; color:#ffffff; margin-bottom:6px; display:block}
  .divider{height:1px;background:#262b4b;border:0;margin:8px 0 16px 0}
  .mini{font-size:12px;color: #001fd4;}
  .chip{display:inline-flex; align-items:center; gap:6px; border:1px solid #2a2e50; padding:6px 10px; border-radius:999px; color:#cbd2ff; background:#10132a}
  .links a{color:#91ddff; text-decoration:none}
  .scroll{max-height:420px; overflow:auto; padding-right:6px}
  .table{width:100%; border-collapse:collapse}
  .table th,.table td{padding:8px 6px;border-bottom:1px solid #24294a;text-align:left;font-size:13px}
  .kpi{border-radius:16px; padding:14px 14px 10px 14px; color:#06111a; background: linear-gradient(135deg, #adfff2, #fff7ad)}
  .kpi h4{margin:0 0 6px 0; font-size:13px; color:#27314e}
  .kpi .big{font-size:24px; font-weight:900; color:#0b1733}
  .hide{display:none !important}
  body:not(.is-authed) .staff-only{display:none}
  body:not(.is-admin) .admin-only{display:none}
  #screenAuth,#screenViewer,#screenStaff,#screenAdmin,#modKLE,#modMedia,#modSocial,#modBrand,#modChecklist,#modRpie{content-visibility:auto;contain-intrinsic-size:0 500px;}
  /* drawer */
  .drawer{position:fixed; inset:0; display:none; z-index:1000}
  .drawer.open{display:block}
  .drawer .backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45)}
  .drawer .panel{position:absolute; top:0; left:0; height:100%; width:320px; background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.2)), #0f1224; border-right:1px solid #2b2f54; padding:16px; box-shadow: 10px 0 30px rgba(0,0,0,.35)}
  .menuItem{display:flex; align-items:center; gap:10px; margin:8px 0; padding:10px 12px; border-radius:12px; background:linear-gradient(135deg,#151a35,#131833); border:1px solid #2c3259; color:#cbd2ff; cursor:pointer}
  .menuItem:hover{ outline:2px solid #3b4184 }
  .menuItem .dot{width:10px;height:10px;border-radius:50%}
  .menuGroupHeader{margin:8px 0;padding:10px 12px;border-radius:12px;background:linear-gradient(135deg,#1a1f3d,#151a33);border:1px solid #2c3259;color:#cbd2ff;font-weight:700;cursor:pointer}
  .menuGroupItems{margin-left:12px}
  .grad1{background:var(--accent4)}
  .grad2{background:var(--accent2)}
  .grad3{background:var(--accent3)}
  .onboard{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.6);z-index:2000}
  .onboard.hidden{display:none}
  #onboardSpotlight{position:absolute;border:2px solid #fff;border-radius:8px;pointer-events:none}
  .onboard .tip{background:#fff;color:#000;padding:20px;border-radius:12px;max-width:90%;text-align:center}
  body.noscroll{overflow:hidden}

  /* ==== Responsive tweaks ==== */
  @media (min-width:1440px){
    .shell{max-width:1400px}
  }
  @media (max-width:1024px){
    .grid-3{grid-template-columns:repeat(2,minmax(0,1fr))}
  }
  @media (max-width:768px){
    .row{flex-direction:column}
    .grid-3,.grid-2{grid-template-columns:1fr}
  }
  @media (max-width:360px){
    .topbar{flex-direction:column;align-items:flex-start}
    .topbar h1{font-size:16px}
  }
</style>
</head>
<body>
<div class="shell">
  <div class="topbar">
    <div style="display:flex; gap:10px; align-items:center">
      <button class="hamburger" id="btnHamburger" aria-label="Menu">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M3 12h18M3 18h18"/></svg>
      </button>
      <h1>Walla Walla District ‚Ä¢ PAO Metrics Tracker</h1>
    </div>
    <div style="display:flex; gap:8px; align-items:center">
      <span class="pill" id="whoPill">Not signed in</span>
      <button class="ghost small" id="backBtn" title="Go back">‚üµ Back</button>
      <button class="ghost small" id="btnSaveProgress" style="display:none">üíæ Save</button>
      <label class="ghost small" id="lblLoadProgress" style="display:none;cursor:pointer">üìÅ Load<input id="inputLoadProgress" type="file" accept="application/json" class="hide" /></label>
    </div>
  </div>

  <!-- UNIT PICK -->
  <section id="screenUnit" class="card" style="margin-top:18px">
    <h3>Choose Unit</h3>
    <div class="grid" style="grid-template-columns:1fr">
      <div><label>Existing Units</label><select id="unitSelectHome" class="input"></select></div>
      <div><button class="cta" id="btnUnitGo" style="margin-top:8px">Continue</button></div>
    </div>
  </section>

  <!-- ROLE PICK -->
  <section id="screenRole" class="grid grid-2" style="margin-top:18px">
    <button class="card" style="background:var(--accent3);color:#281a07; cursor:pointer" data-role="viewer">
      <div style="font-size:22px;font-weight:800">Viewer</div><div class="mini">See progress & click product links</div>
    </button>
    <button class="card" style="background:var(--accent4);color:#041d13; cursor:pointer" data-role="staff">
      <div style="font-size:22px;font-weight:800">Staff</div><div class="mini">Enter my work & links</div>
    </button>
    <button class="card" style="background:var(--accent2);color:#1d0c16; cursor:pointer" data-role="chief">
      <div style="font-size:22px;font-weight:800">PAO Chief</div><div class="mini">Set goals & staff</div>
    </button>
    <button class="card" style="background:var(--accent1);color:#0a141c; cursor:pointer" data-role="admin">
      <div style="font-size:22px;font-weight:800">Register</div><div class="mini">Manage all units</div>
    </button>
  </section>

  <!-- AUTH -->
  <section id="screenAuth" class="card hide" style="margin-top:18px">
    <!-- Admin Supabase auth -->
    <div id="adminAuth" class="hide">
      <section>
        <h3>Sign in</h3>
        <input id="si-email" type="email" placeholder="Email" required />
        <input id="si-pass" type="password" placeholder="Password" required />
        <button type="button" id="btnAdminSignIn" onclick="nwwSignIn()">Sign in</button>
        <button type="button" onclick="requestPasswordReset()" class="mini">Reset password</button>
      </section>
      <section style="margin-top:16px">
        <h3>Sign up</h3>
        <input id="su-email" type="email" placeholder="Email" required />
        <input id="su-pass" type="password" placeholder="Password" required />
        <input id="su-confirm" type="password" placeholder="Confirm password" required />
        <label for="su-role">Role</label>
        <select id="su-role" class="input">
          <option value="admin">Admin</option>
          <option value="staff">Staff</option>
          <option value="chief">PAO Chief</option>
        </select>
        <button type="button" id="btnAdminSignUp" onclick="nwwSignUp()">Sign up</button>
      </section>
    </div>

    <div id="adminReset" class="hide">
      <h3>Reset Password</h3>
      <div class="grid" style="grid-template-columns:1fr">
        <div><label>New Password</label><input id="rp-new" type="password" class="input" placeholder="New password" /></div>
        <div><label>Confirm Password</label><input id="rp-confirm" type="password" class="input" placeholder="Confirm password" /></div>
        <div><button class="cta" id="btnAdminReset" style="margin-top:8px" onclick="finishPasswordReset()">Submit</button></div>
      </div>
    </div>

    <pre id="status">Not signed in</pre>

    <!-- PAO Chief email/password auth -->
    <div id="chiefAuth" class="hide">
      <h3>PAO Chief Sign‚Äëin</h3>
      <div class="grid" style="grid-template-columns:1fr">
        <div><label>Email</label><input id="chief-email" type="email" class="input" placeholder="Email" /></div>
        <div><label>Password</label><input id="chief-pass" type="password" class="input" placeholder="Password" /></div>
        <div><button class="cta" id="btnChiefLogin" style="margin-top:8px">Sign in</button></div>
      </div>
    </div>

    <!-- Staff email/password auth -->
    <div id="staffAuth" class="hide">
      <h3>Staff Sign‚Äëin</h3>
      <div class="grid" style="grid-template-columns:1fr">
        <div><label>Email</label><input id="staff-email" type="email" class="input" placeholder="Email" /></div>
        <div><label>Password</label><input id="staff-pass" type="password" class="input" placeholder="Password" /></div>
        <div><button class="cta" id="btnStaffLogin" style="margin-top:8px">Sign in</button></div>
      </div>
    </div>
  </section>

  <!-- VIEWER -->
  <section id="screenViewer" class="hide">
    <div class="row" style="margin-top:18px">
      <div class="col">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>Portfolio Overview</h3>
            <span class="badge"><span class="mini">Timeframe</span>
              <select id="tfViewer" class="input" style="width:auto; margin-left:8px">
                <option value="M">Monthly</option><option value="Q">Quarterly</option><option value="Y">Annual</option>
              </select>
              <span id="tfViewerPick"></span>
            </span>
          </div>
          <div class="divider"></div>
          <div class="grid grid-3">
            <div class="card" style="background:var(--accent4);color:#07241a">
              <div class="mini">Outputs</div><div style="font-size:30px;font-weight:900" id="sumOutPct">0%</div><div class="mini" id="sumOutCounts">0 / 0</div>
            </div>
            <div class="card" style="background:var(--accent3);color:#281a07">
              <div class="mini">Outtakes</div><div style="font-size:30px;font-weight:900" id="sumOtkPct">0%</div><div class="mini" id="sumOtkCounts">0 / 0</div>
            </div>
            <div class="card" style="background:var(--accent2);color:#1d0c16">
              <div class="mini">Outcomes (avg)</div><div style="font-size:30px;font-weight:900" id="sumOcmPct">0%</div><div class="mini" id="sumOcmCounts">‚Äî</div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="grid grid-2">
            <div class="card"><h3>Outputs by Product</h3><div id="tblOutputs" class="scroll"></div></div>
            <div class="card"><h3>Outtakes by Type</h3><div id="tblOuttakes" class="scroll"></div></div>
          </div>
          <div class="card" style="margin-top:16px"><h3>Campaign Breakdown</h3><div id="tblCampaigns" class="scroll"></div></div>
          <div class="card" style="margin-top:16px">
            <h3>All Product Links (click to open)</h3><div class="scroll links" id="allLinks"></div>
          </div>
        </div>
      </div>
      <div class="col">
        <div class="card" style="background:var(--accent1); color:#06131a">
          <h3 style="color:#111a2a">At‚Äëa‚ÄëGlance</h3>
          <div class="kpi"><h4>Top Contributors (Outputs)</h4><div class="big" id="leadersOut">‚Äî</div></div>
          <div style="height:12px"></div>
          <div class="kpi"><h4>Top Contributors (Outtakes)</h4><div class="big" id="leadersOtk">‚Äî</div></div>
          <div style="height:12px"></div>
          <div class="kpi"><h4>Outcomes Leaders</h4><div class="big" id="leadersOcm">‚Äî</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- STAFF (inputs) -->
  <section id="screenStaff" class="hide staff-only">
    <div class="row" style="margin-top:18px; flex-direction:column">
      <div class="col">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>My Inputs</h3>
            <span class="badge"><span class="mini">Timeframe</span>
              <select id="tfStaff" class="input" style="width:auto; margin-left:8px">
                <option value="M">Monthly</option><option value="Q">Quarterly</option><option value="Y">Annual</option>
              </select>
              <span id="tfStaffPick"></span>
            </span>
          </div>
            <div class="divider"></div>
            <div class="grid" style="grid-template-columns:1fr">
              <div><label>Campaign</label><select id="staffCampaign" class="input"></select></div>
            </div>
            <div id="staffMetrics" style="display:none">
              <div class="grid" style="grid-template-columns:1fr">
                <div class="card" style="background:rgba(21,23,42,.75); border-color:#323761">
                  <h3>Outputs ‚Äî Products I produced</h3>
                  <div class="grid grid-2">
                    <div><label>Template</label><select id="outTemplate" class="input"></select></div>
                    <div><label>Product Type</label><select id="outProdType" class="input"></select></div>
                    <div id="outCampaignWrap" class="hide"><label>Campaign</label><select id="outCampaign" class="input"></select></div>
                    <div id="otherProdWrap" class="hide"><label>Other (specify)</label><input id="otherProd" class="input" placeholder="e.g., Podcast episode"/></div>
                    <div><label>Quantity</label><input id="outQty" type="number" min="1" class="input" value="1"/></div>
                    <div><label>Links (comma or new line)</label><textarea id="outLinks" rows="2" class="input" placeholder="https://‚Ä¶"></textarea></div>
                  </div>
                  <div style="display:flex; gap:10px; margin-top:10px">
                    <button class="cta" id="btnAddOutput">Add Output</button><button class="ghost btn" id="btnClearOutput">Clear</button>
                  </div>
                  <div class="scroll" id="outList" style="margin-top:10px"></div>
                </div>

                <div class="card" style="background:rgba(21,23,42,.75); border-color:#323761">
                  <h3>Outtakes ‚Äî Engagements & reach</h3>
                  <div class="grid grid-2">
                    <div><label>Template</label><select id="otkTemplate" class="input"></select></div>
                    <div><label>Outtake Type</label><select id="otkType" class="input"></select></div>
                    <div id="otkCampaignWrap" class="hide"><label>Campaign</label><select id="otkCampaign" class="input"></select></div>
                    <div id="otkOtherWrap" class="hide"><label>Other (specify)</label><input id="otkOther" class="input" placeholder="e.g., Survey completes"/></div>
                    <div><label>Quantity</label><input id="otkQty" type="number" min="1" class="input" value="1"/></div>
                    <div><label>Notes / Links (optional)</label><textarea id="otkNotes" rows="2" class="input" placeholder="Context or URLs"></textarea></div>
                  </div>
                  <div style="display:flex; gap:10px; margin-top:10px">
                    <button class="cta" id="btnAddOuttake">Add Outtake</button><button class="ghost btn" id="btnClearOuttake">Clear</button>
                  </div>
                  <div class="scroll" id="otkList" style="margin-top:10px"></div>
                </div>
              </div>

              <div class="card" style="margin-top:16px;background:rgba(21,23,42,.75); border-color:#323761">
                <h3>Outcomes ‚Äî Objective progress</h3>
                <div class="grid" style="grid-template-columns:1fr">
                  <div><label>Outcome Metric</label><select id="ocmKey" class="input"></select></div>
                  <div id="ocmCampaignWrap" class="hide"><label>Campaign</label><select id="ocmCampaign" class="input"></select></div>
                  <div id="ocmOtherWrap" class="hide"><label>Other (specify)</label><input id="ocmOther" class="input" placeholder="e.g., Public trust"/></div>
                  <div><label>My status (% toward target)</label><input id="ocmPct" type="range" min="0" max="100" value="0" /><div class="mini" id="ocmVal">0%</div></div>
                  <div><button class="cta" id="btnSaveOutcome" style="margin-top:8px">Save Outcome</button></div>
                </div>
                <div class="scroll" id="ocmList" style="margin-top:10px"></div>
              </div>
            </div>
        </div>
      </div>
      <div class="col">
        <div id="staffProgress" class="card" style="background:var(--accent1); color:#07131a">
          <h3 style="color:#111a2a">My Progress</h3>
          <div class="kpi"><h4>Outputs completion</h4><div class="big" id="kpiOutPct">0%</div></div>
          <div style="height:12px"></div>
          <div class="kpi"><h4>Outtakes completion</h4><div class="big" id="kpiOtkPct">0%</div></div>
          <div style="height:12px"></div>
          <div class="kpi"><h4>Outcomes (avg)</h4><div class="big" id="kpiOcmPct">0%</div></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PAO CHIEF -->
  <section id="screenChief" class="hide staff-only">
    <div class="row" style="margin-top:18px; flex-direction:column">
      <div class="col">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <h3>PAO Chief ‚Ä¢ Settings & Staff</h3>
            <span class="badge"><span class="mini">Timeframe</span>
              <select id="tfChief" class="input" style="width:auto; margin-left:8px">
                <option value="M">Monthly</option><option value="Q">Quarterly</option><option value="Y">Annual</option>
              </select>
              <span id="tfChiefPick"></span>
            </span>
          </div>
          <div class="divider"></div>
          <div class="grid" style="grid-template-columns:1fr">
            <div class="card" style="background:#ffffff22;border-color:#ffffff55">
              <h3>Staff</h3>
              <div class="grid" style="grid-template-columns:1fr">
                <div><label>Staff Name</label><input id="staffName" class="input" placeholder="e.g., A. Johnson"></div>
                <div><button class="cta" id="btnAddStaff" style="margin-top:8px">Add / Update</button></div>
              </div>
              <div class="scroll" id="staffList" style="margin-top:10px"></div>
              <div style="display:flex; gap:8px; margin-top:12px">
                <button class="ghost btn" id="btnExport">Export JSON</button>
                <label class="ghost btn" style="cursor:pointer;display:inline-flex;align-items:center;gap:8px">
                  <input id="importFile" type="file" accept="application/json" class="hide" />Import JSON
                </label>
              </div>
            </div>
            <div class="card" style="background:#ffffff22;border-color:#ffffff55">
              <h3>Social Media API Keys</h3>
              <div class="grid">
                <div><label>Facebook API Key</label><input id="apiKeyFacebook" class="input" placeholder="Enter Key"></div>
                <div><label>Instagram API Key</label><input id="apiKeyInstagram" class="input" placeholder="Enter Key"></div>
                <div><label>X API Key</label><input id="apiKeyX" class="input" placeholder="Enter Key"></div>
                <div><label>LinkedIn API Key</label><input id="apiKeyLinkedin" class="input" placeholder="Enter Key"></div>
              </div>
              <div style="display:flex; gap:10px; margin-top:10px">
                <button class="cta" id="btnSaveApiKeys">Save API Keys</button>
              </div>
            </div>

            <div class="card" style="background:#ffffff22;border-color:#ffffff55">
              <h3>Campaigns</h3>
              <div class="grid" style="grid-template-columns:1fr">
                <div><label>Name</label><input id="cmpName" class="input" placeholder="Campaign name"></div>
                <div><label>Code</label><input id="cmpCode" class="input" placeholder="Code"></div>
                <div><label>Color</label><input id="cmpColor" type="color" class="input" value="#000000"></div>
                <div><label>Position</label><input id="cmpPosition" type="number" class="input" value="0"></div>
                <div><label><input type="checkbox" id="cmpActive" checked> Active</label></div>
                <div><button class="cta" id="btnSaveCampaign" style="margin-top:8px">Save Campaign</button></div>
              </div>
              <div class="scroll" id="campaignList" style="margin-top:10px"></div>
            </div>

            <div class="card" style="background:#ffffff22;border-color:#ffffff55">
              <h3>Campaign Goals</h3>
              <div class="grid" style="grid-template-columns:1fr">
                <div><label>Campaign</label><select id="goalCampaign" class="input"></select></div>
                <div><label>Kind</label><select id="goalKind" class="input"><option value="output">Output</option><option value="outtake">Outtake</option><option value="outcome">Outcome</option></select></div>
                <div><label>Label</label><input id="goalLabel" class="input" placeholder="Metric label"></div>
                <div><label>Target</label><input id="goalTarget" type="number" class="input" value="0"></div>
                <div><label>Timeframe</label><select id="goalTimeframe" class="input"><option value="M">Monthly</option><option value="Q">Quarterly</option><option value="Y">Annual</option></select></div>
                <div><button class="cta" id="btnSaveCampaignGoal" style="margin-top:8px">Save Goal</button></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Goals & chief dashboard -->
      <div class="col">
        <div class="card" style="background:var(--accent3); color:#24160a">
          <h3>Set Goals (Counts & Outcomes)</h3>
          <div class="mini">Outputs/Outtakes by count; Outcomes as custom % metrics.</div>
          <div class="divider"></div>
          <div class="card" style="background:#ffffff33;border-color:#ffffff66">
            <h3>Outputs Goals</h3>
            <div class="grid" style="grid-template-columns:1fr">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <select id="outSel" class="input"></select>
                <input id="outOther" class="input" placeholder="Metric name" style="display:none"/>
                <input type="range" id="outRange" min="0" max="50" value="0"/>
                <span class="mini" id="outVal">0</span>
                <button class="cta small" id="addOut">Add metric</button>
              </div>
              <div id="outTable"></div>
            </div>
          </div>
          <div class="card" style="margin-top:12px;background:#ffffff33;border-color:#ffffff66">
            <h3>Outtakes Goals</h3>
            <div class="grid" style="grid-template-columns:1fr">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <select id="otkSel" class="input"></select>
                <input id="otkOtherGoal" class="input" placeholder="Metric name" style="display:none"/>
                <input type="range" id="otkRange" min="0" max="50" value="0"/>
                <span class="mini" id="otkVal">0</span>
                <button class="cta small" id="addOtk">Add metric</button>
              </div>
              <div id="otkTable"></div>
            </div>
          </div>
          <div class="card" style="margin-top:12px;background:#ffffff33;border-color:#ffffff66">
            <h3>Outcomes (Custom % Metrics)</h3>
            <div class="grid" style="grid-template-columns:1fr">
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                <select id="ocmSel" class="input"></select>
                <input id="ocmOtherGoal" class="input" placeholder="Metric name" style="display:none"/>
                <input type="range" id="ocmRange" min="0" max="100" value="0"/>
                <span class="mini" id="ocmVal">0%</span>
                <button class="cta small" id="addOcm">Add metric</button>
              </div>
              <div id="ocmTable"></div>
            </div>
          </div>
          <div style="display:flex; gap:10px; margin-top:12px"><button class="cta" id="btnSaveGoals">Save All Goals</button></div>
        </div>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>PAO Chief Dashboard</h3>
      <div class="grid grid-3">
        <div class="card" style="background:var(--accent4); color:#0d1e19"><div class="mini">Outputs</div><div style="font-size:30px;font-weight:900" id="chiefOutPct">0%</div><div class="mini" id="chiefOutCounts">0 / 0</div></div>
        <div class="card" style="background:var(--accent1); color:#0a141c"><div class="mini">Outtakes</div><div style="font-size:30px;font-weight:900" id="chiefOtkPct">0%</div><div class="mini" id="chiefOtkCounts">0 / 0</div></div>
        <div class="card" style="background:var(--accent2); color:#1d0c16"><div class="mini">Outcomes (avg)</div><div style="font-size:30px;font-weight:900" id="chiefOcmPct">0%</div><div class="mini" id="chiefOcmCounts">‚Äî</div></div>
      </div>
      <div class="divider"></div>
      <div class="grid grid-2">
        <div class="card"><h3>Outputs by Product</h3><div class="scroll" id="chiefTblOutputs"></div></div>
        <div class="card"><h3>Outtakes by Type</h3><div class="scroll" id="chiefTblOuttakes"></div></div>
      </div>
    </div>
  </section>

  <!-- ADMIN (global) -->
  <section id="screenAdmin" class="card hide admin-only" style="margin-top:18px">
    <h3>Register Dashboard</h3>
    <div class="grid" style="grid-template-columns:1fr">
      <div><label>Select Unit</label><select id="adminUnit" class="input"></select></div>
      <div><button class="cta" id="btnAdminOpen" style="margin-top:8px">Open Unit</button></div>
      <div class="divider"></div>
      <div><h4>Registered Units</h4><div id="unitList" class="scroll"></div></div>
      <div><label>Add Unit</label><input id="adminNewUnit" class="input" placeholder="e.g., Unit A" /></div>
      <div><button class="ghost small" id="btnAdminAddUnit" style="margin-top:8px">Add Unit</button></div>
      <div class="divider"></div>
      <div><button class="danger small" id="btnReset">Factory Reset</button></div>
      <div class="divider"></div>
      <div><label>Set Admin PIN</label><input id="setGlobalPIN" type="password" class="input" placeholder="New PIN" /></div>
      <div><button class="ghost small" id="btnSaveGlobalPIN" style="margin-top:8px">Save PIN</button></div>
      <div class="divider"></div>
      <div><h4>PAO Chiefs</h4><div id="chiefAdminList" class="scroll"></div></div>
      <div><label>Add PAO Chief</label><input id="adminNewChief" class="input" placeholder="Name" /></div>
      <div><label>Assign to Unit</label><select id="adminNewChiefUnit" class="input"></select></div>
      <div><button class="ghost small" id="btnAdminAddChief" style="margin-top:8px">Add PAO Chief</button></div>
      <div class="divider"></div>
      <div><h4>User Roles</h4><div id="adminUserTable" class="scroll"><table id="userRolesTable" class="table"></table></div></div>
      <div class="divider"></div>
      <div class="card" style="background:#ffffff22;border-color:#ffffff55">
        <h3>AI API Keys</h3>
        <div class="grid">
          <div><label>OpenAI API Key</label><input id="adminApiKeyOpenAI" class="input" placeholder="Enter Key"></div>
          <div><label>Gemini API Key</label><input id="adminApiKeyGemini" class="input" placeholder="Enter Key"></div>
          <div><label>CamoGPT API Key</label><input id="adminApiKeyCamogpt" class="input" placeholder="Enter Key"></div>
          <div><label>AskSage API Key</label><input id="adminApiKeyAsksage" class="input" placeholder="Enter Key"></div>
        </div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <button class="cta" id="btnAdminSaveAiKeys">Save AI API Keys</button>
        </div>
      </div>
    </div>
  </section>

  <!-- NEW MODULES (via hamburger) -->
  <section id="modKLE" class="hide staff-only"></section>
  <section id="modMedia" class="hide staff-only"></section>
  <section id="modSocial" class="hide staff-only"></section>
  <section id="modBrand" class="hide staff-only"></section>
  <section id="modChecklist" class="hide staff-only"></section>
  <section id="modRpie" class="hide staff-only"><iframe src="rpie.html" id="rpieFrame" style="width:100%;height:80vh;border:none"></iframe></section>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="backdrop" id="drawerClose"></div>
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="pill">Role Menu</div>
      <button class="ghost small" id="drawerCloseBtn">Close</button>
    </div>
    <div id="menuItems"></div>
  </div>
</div>

<div id="onboardOverlay" class="onboard hidden">
  <div id="onboardSpotlight"></div>
  <div class="tip">
    <div id="onboardText"></div>
    <div style="margin-top:12px;display:flex;gap:10px;justify-content:center;">
      <button class="ghost small" id="onboardPrev">Prev</button>
      <button class="ghost small" id="onboardNext">Next</button>
    </div>
    <label style="margin-top:8px;display:flex;align-items:center;gap:6px;justify-content:center;font-size:14px;">
      <input type="checkbox" id="onboardSkip"> Don't show again
    </label>
  </div>
</div>

<button class="ghost small" id="scrollTop" style="position:fixed;right:22px;bottom:22px;z-index:99">‚Üë Top</button>

<script>
/* ================= DATA ================= */
const STORAGE_KEY_BASE='nww_pao_metrics_onepage_v1';
const UNITS_KEY='nww_pao_units';
const GLOBAL_PIN_KEY='nww_pao_global_pin';
const CHIEFS_KEY='nww_pao_chiefs';
function loadChiefs(){ return JSON.parse(localStorage.getItem(CHIEFS_KEY)||'[]'); }
function saveChiefs(list){ localStorage.setItem(CHIEFS_KEY, JSON.stringify(list)); }
const AI_KEYS_KEY='nww_pao_ai_keys';
let aiApiKeys = JSON.parse(localStorage.getItem(AI_KEYS_KEY)||'{}');
function saveAiApiKeys(){ localStorage.setItem(AI_KEYS_KEY, JSON.stringify(aiApiKeys)); }
let currentUnit='default';
let STORAGE_KEY=`${STORAGE_KEY_BASE}_${currentUnit}`;
let globalAdminPIN = localStorage.getItem(GLOBAL_PIN_KEY) || '0000';
const ONBOARD_KEY='nww_onboard_done';
let campaigns=[]; // loaded from Supabase
let editCampaignId=null;
const defaultOutcomes=[
  {name:'Awareness lift', desc:''},
  {name:'Understanding of issue/process', desc:''},
  {name:'Trust/credibility indicators', desc:''},
  {name:'Intent to participate/comply', desc:''},
  {name:'Permit/application completeness', desc:''},
  {name:'Public meeting civility/productivity', desc:''},
  {name:'Rumor reduction/Misinfo countered', desc:''},
  {name:'Safety behavior adoption (e.g., life jacket use)', desc:''},
  {name:'Preparedness actions taken', desc:''},
  {name:'Support for decisions/policies', desc:''},
  {name:'Stakeholder collaboration actions', desc:''}
];
const def={
  chiefId:null,
  staff:[], // {id,name}
  templates:{
    outputs:[
      {name:'News release', qty:1, links:[]},
      {name:'Media advisory', qty:1, links:[]},
      {name:'Media engagement (interviews/briefs)', qty:1, links:[]},
      {name:'Web article/Feature', qty:1, links:[]},
      {name:'DVIDS upload (photo/video)', qty:1, links:[]},
      {name:'Social posts (FB/X/IG/LI)', qty:1, links:[]},
      {name:'Infographic', qty:1, links:[]},
      {name:'Factsheet/One-pager', qty:1, links:[]},
      {name:'FAQ/Q&A', qty:1, links:[]},
      {name:'Video package/Reel/Short', qty:1, links:[]},
      {name:'Photo set', qty:1, links:[]},
      {name:'Public meeting/Open house', qty:1, links:[]},
      {name:'Stakeholder briefing deck', qty:1, links:[]},
      {name:'Talking points/Speech', qty:1, links:[]},
      {name:'Newsletter (internal/external)', qty:1, links:[]},
      {name:'Public notice', qty:1, links:[]},
      {name:'Blog post', qty:1, links:[]},
      {name:'Radio PSA/Podcast guest', qty:1, links:[]},
      {name:'Op-ed/LTE', qty:1, links:[]},
      {name:'Email to distro/Workforce note', qty:1, links:[]},
      {name:'Congressional update', qty:1, links:[]}
    ],
    outtakes:[
      {name:'Reach/Impressions', qty:1, notes:''},
      {name:'Engagement rate', qty:1, notes:''},
      {name:'Reactions/Comments/Shares', qty:1, notes:''},
      {name:'Click-through rate', qty:1, notes:''},
      {name:'Video views', qty:1, notes:''},
      {name:'Average watch time', qty:1, notes:''},
      {name:'Web sessions', qty:1, notes:''},
      {name:'Time on page', qty:1, notes:''},
      {name:'Bounce rate', qty:1, notes:''},
      {name:'Media pickups', qty:1, notes:''},
      {name:'Share of voice', qty:1, notes:''},
      {name:'Earned sentiment', qty:1, notes:''},
      {name:'Event attendance', qty:1, notes:''},
      {name:'Questions received', qty:1, notes:''},
      {name:'Call/email volume', qty:1, notes:''},
      {name:'Newsletter opens', qty:1, notes:''},
      {name:'Newsletter CTR', qty:1, notes:''}
    ]
  },
  goals:{
    M:{outputs:{},outtakes:{},outcomes:{}},
    Q:{outputs:{},outtakes:{},outcomes:{}},
    Y:{outputs:{},outtakes:{},outcomes:{}}
  },
  entries:[], // metrics: {id,userId,type:'output'|'outtake'|'outcome', tf, tfKey, ts, data:{...}}
  kle:[],    // KLE
  media:[],  // media queries
  social:[], // social posts
  brand:{ policy:{brandGuideUrl:'', milHost:'', approvalsRequired:['PAO Release','OPSEC II','Caption/VI','Accessibility','Records Tag']}, inventory:[] },
  checklists:[], // pre-release
  apiKeys:{ facebook:'', instagram:'', x:'', linkedin:'' }
};
let db = load(currentUnit);
function ensureUnitList(unit){
  const list = JSON.parse(localStorage.getItem(UNITS_KEY)||'[]');
  if(!list.includes(unit)){ list.push(unit); localStorage.setItem(UNITS_KEY, JSON.stringify(list)); }
}
function populateUnitSelect(sel){
  const el = typeof sel==='string'? $(sel) : sel;
  if(!el) return;
  el.innerHTML='';
  const units = JSON.parse(localStorage.getItem(UNITS_KEY)||'[]');
  units.forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; el.appendChild(o); });
  el.value = currentUnit;
}
function load(unit){
  currentUnit = unit;
  STORAGE_KEY = `${STORAGE_KEY_BASE}_${unit}`;
  ensureUnitList(unit);
  try{
    const raw=localStorage.getItem(STORAGE_KEY);
    let data = raw? JSON.parse(raw) : (localStorage.setItem(STORAGE_KEY, JSON.stringify(def)), structuredClone(def));
    // migrate legacy template arrays of strings to object format
    if(Array.isArray(data.templates?.outputs) && typeof data.templates.outputs[0] === 'string'){
      data.templates.outputs = data.templates.outputs.map(name=>({name, qty:1, links:[]}));
    }
    if(Array.isArray(data.templates?.outtakes) && typeof data.templates.outtakes[0] === 'string'){
      data.templates.outtakes = data.templates.outtakes.map(name=>({name, qty:1, notes:''}));
    }
    ['M','Q','Y'].forEach(tf=>{
      const oc=data.goals?.[tf]?.outcomes;
      if(Array.isArray(oc)){
        data.goals[tf].outcomes=Object.fromEntries(oc.map(o=>[o.name||o, o.goal||0]));
      }
    });
    if(data.chiefPIN && !data.chiefId){ data.chiefId=null; delete data.chiefPIN; }
    if(Array.isArray(data.staff)){
      data.staff = data.staff.map(s => ({ id: s.id, name: s.name }));
    }
    return data;
  }catch(e){
    return structuredClone(def);
  }
}
function save(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
  ensureUnitList(currentUnit);
  if(window.PAOWeb?.saveUnitData){
    window.PAOWeb.saveUnitData(db).catch(err=>console.error('Supabase save failed', err));
  }
}

async function saveEntryToSupabase(entry){
  try{
    if(!window.supabase) return;
    const unit_id = window.CURRENT?.unit_id;
    if(!unit_id) return; // cannot save without a selected unit
    if(entry.type==='output'){
      await supabase.from('outputs').insert({
        unit_id,
        user_id: entry.userId,
        timeframe: entry.tf,
        tf_key: entry.tfKey,
        product_type: entry.data.product,
        quantity: entry.data.qty,
        links: entry.data.links,
        campaign_id: entry.data.campaign || null
      });
    }else if(entry.type==='outtake'){
      await supabase.from('outtakes').insert({
        unit_id,
        user_id: entry.userId,
        timeframe: entry.tf,
        tf_key: entry.tfKey,
        outtake_type: entry.data.kind,
        quantity: entry.data.qty,
        notes: entry.data.notes,
        campaign_id: entry.data.campaign || null
      });
    }else if(entry.type==='outcome'){
      await supabase.from('outcomes').insert({
        unit_id,
        user_id: entry.userId,
        timeframe: entry.tf,
        tf_key: entry.tfKey,
        outcome_label: entry.data.metric,
        percent: entry.data.pct,
        campaign_id: entry.data.campaign || null
      });
    }
  }catch(err){ console.error('Supabase insert failed', err); }
}

async function loadCampaigns(){
  try{
    if(!window.supabase) return;
    const { data } = await supabase.rpc('list_campaigns');
    campaigns = data || [];
    const opts = ['<option value="">(none)</option>']
      .concat(campaigns.map(c=>`<option value="${c.id}">${c.name}</option>`)).join('');
    ['outCampaign','otkCampaign','ocmCampaign','goalCampaign','staffCampaign'].forEach(id=>{
      const el=document.getElementById(id); if(el) el.innerHTML=opts;
    });
    renderCampaignList();
  }catch(err){ console.error('loadCampaigns failed', err); }
}

function renderCampaignList(){
  const list=document.getElementById('campaignList');
  if(!list) return;
  list.innerHTML = campaigns.map(c=>
    `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
       <span style="display:flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;border-radius:50%;background:${c.color||'#000'}"></span>${c.name}</span>
       <button class="ghost small" data-edit="${c.id}">Edit</button>
     </div>`
  ).join('');
  list.querySelectorAll('[data-edit]').forEach(btn=> btn.addEventListener('click', e=>{
    const id=e.target.dataset.edit;
    const c=campaigns.find(x=>x.id==id);
    if(!c) return;
    editCampaignId=id;
    $('#cmpName').value=c.name||'';
    $('#cmpCode').value=c.code||'';
    $('#cmpColor').value=c.color||'#000000';
    $('#cmpPosition').value=c.position||0;
    $('#cmpActive').checked=!!c.is_active;
  }));
}

async function refreshCampaignProgress(){
  try{
    if(!window.supabase) return;
    const tfMap={M:'monthly',Q:'quarterly',Y:'annual'};
    const { data } = await supabase.rpc('campaign_progress', { timeframe: tfMap[cur.tf] });
    const rows = data || [];
    tbl($('#tblCampaigns'), rows, [
      {label:'Campaign', render:r=>{
        const c=campaigns.find(x=>x.code===r.metric || x.name===r.metric);
        const clr=c?.color||'#000';
        return `<span style="display:inline-flex;align-items:center;gap:6px;"><span style="width:12px;height:12px;border-radius:50%;background:${clr}"></span>${r.metric}</span>`;
      }},
      {label:'Goal', render:r=>r.goal_target||0},
      {label:'% of Goal', render:r=> toPct((r.pct_of_goal||0)/100)}
    ]);
  }catch(err){ console.error('campaign_progress failed', err); }
}

async function loadEntriesFromSupabase(){
  try{
    if(!window.supabase) return;
    const unit_id = window.CURRENT?.unit_id;
    const { data: { user: u } } = await supabase.auth.getUser();
    if(!u || !unit_id) return;
    const [outs, otks, ocms] = await Promise.all([
      supabase.from('outputs').select('*').eq('user_id', u.id).eq('unit_id', unit_id),
      supabase.from('outtakes').select('*').eq('user_id', u.id).eq('unit_id', unit_id),
      supabase.from('outcomes').select('*').eq('user_id', u.id).eq('unit_id', unit_id)
    ]);
    const mapOuts = (outs.data||[]).map(o=>({id:o.id, userId:o.user_id, type:'output', tf:o.timeframe, tfKey:o.tf_key, ts:Date.parse(o.created_at), data:{product:o.product_type, qty:o.quantity, links:o.links||[], campaign:o.campaign_id||null}}));
    const mapOtks = (otks.data||[]).map(o=>({id:o.id, userId:o.user_id, type:'outtake', tf:o.timeframe, tfKey:o.tf_key, ts:Date.parse(o.created_at), data:{kind:o.outtake_type, qty:o.quantity, notes:o.notes||'', campaign:o.campaign_id||null}}));
    const mapOcms = (ocms.data||[]).map(o=>({id:o.id, userId:o.user_id, type:'outcome', tf:o.timeframe, tfKey:o.tf_key, ts:Date.parse(o.created_at), data:{metric:o.outcome_label, pct:o.percent||0, campaign:o.campaign_id||null}}));
    db.entries = [...mapOuts, ...mapOtks, ...mapOcms];
    save();
    refreshStaff();
    if(typeof refreshViewerIf==='function') refreshViewerIf();
  }catch(err){ console.error('Supabase load failed', err); }
}

function buildUnitPicker(){
  // Prefer Supabase-provided units when available
  if (typeof reloadUnits === 'function') {
    reloadUnits();
  } else {
    // Fallback to local storage units (offline mode)
    populateUnitSelect('#unitSelectHome');
  }
}

/* ================= HELPERS ================= */
const $=s=>document.querySelector(s); const $$=s=>Array.from(document.querySelectorAll(s));
function uid(){return Math.random().toString(36).slice(2,9)}
function clamp(n,min,max){return Math.max(min,Math.min(max,n))}
function toPct(v){return `${Math.round((v||0)*100)}%`}
function sum(o){return Object.values(o).reduce((a,b)=>a+(b||0),0)}
function todayISO(){return new Date().toISOString().slice(0,10)}
function parseLinks(txt){return (txt||'').split(/[\n,]/).map(s=>s.trim()).filter(Boolean)}
function uniqByName(arr){const seen=new Set();return arr.filter(o=>{if(seen.has(o.name))return false;seen.add(o.name);return true;})}
function goalNames(type){const names=new Set();Object.values(db.goals||{}).forEach(g=>Object.keys(g[type]||{}).forEach(n=>names.add(n)));return [...names];}
function getOutputNames(){return [...new Set([...(def.templates.outputs||[]).map(t=>t.name),...(db.templates.outputs||[]).map(t=>t.name),...goalNames('outputs')])];}
function getOuttakeNames(){return [...new Set([...(def.templates.outtakes||[]).map(t=>t.name),...(db.templates.outtakes||[]).map(t=>t.name),...goalNames('outtakes')])];}
function getOutcomeNames(){return [...new Set([...defaultOutcomes.map(o=>o.name),...goalNames('outcomes')])];}
function year(d){return d.getFullYear()}
function monthKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
function quarter(d){return Math.floor(d.getMonth()/3)+1}
function quarterKey(d){return `${d.getFullYear()}-Q${quarter(d)}`}
function tfKeyOf(tf, dLike){const d = dLike? new Date(dLike): new Date(); if(tf==='M') return monthKey(d); if(tf==='Q') return quarterKey(d); return String(year(d))}

/* ================= STATE ================= */
var role=null, user=null, cur={tf:'M',key:tfKeyOf('M')};
const whoPill=$('#whoPill'); const backBtn=$('#backBtn'); const scrollTopBtn=$('#scrollTop');
const btnHamburger=$('#btnHamburger'); const drawer=$('#drawer'); const menuItems=$('#menuItems');
const btnSaveProgress=$('#btnSaveProgress'); const lblLoadProgress=$('#lblLoadProgress'); const inputLoadProgress=$('#inputLoadProgress');
const onboardOverlay=$('#onboardOverlay'), onboardSpotlight=$('#onboardSpotlight'), onboardText=$('#onboardText');
const onboardPrev=$('#onboardPrev'), onboardNext=$('#onboardNext'), onboardSkip=$('#onboardSkip');
const steps=[
  {id:'btnHamburger', text:'Open the main menu'},
  {id:'btnAddOutput', text:'Record an output'},
  {id:'btnAddOuttake', text:'Track outtakes'},
  {id:'btnSaveGoals', text:'Save your goals'}
];
let curStep=0;

/* ================= NAV ================= */
let currentScreen='unit';
const screenHistory=[];
backBtn.addEventListener('click', ()=>{
  const prev=screenHistory.pop();
  if(prev) show(prev, true);
});
backBtn.style.display='none';
scrollTopBtn.addEventListener('click', ()=> window.scrollTo({top:0,behavior:'smooth'}));
btnSaveProgress.addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='pao_metrics_progress.json'; a.click();
});
inputLoadProgress.addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return; const fr=new FileReader();
  fr.onload=()=>{ try{ db=JSON.parse(fr.result); save(); alert('Progress loaded'); location.reload(); }catch(err){ alert('Invalid JSON'); } };
  fr.readAsText(f); inputLoadProgress.value='';
});
function show(which, isBack=false){
  const hideHamburger=['unit','role','viewer','staffAuth','chiefAuth','adminAuth','adminReset'];
  if(!isBack && currentScreen && which!==currentScreen) screenHistory.push(currentScreen);
  currentScreen=which;
  backBtn.style.display = screenHistory.length ? '' : 'none';
  btnHamburger.style.display = hideHamburger.includes(which) ? 'none' : '';
  ['screenUnit','screenRole','screenAuth','screenViewer','screenStaff','screenChief','screenAdmin','modKLE','modMedia','modSocial','modBrand','modChecklist','modRpie'].forEach(id=> $('#'+id).classList.add('hide'));
  $('#askAIModule')?.classList.add('hide');
  if(which==='unit'){
    role=null;user=null;whoPill.textContent='Select unit';
    document.body.classList.remove('is-authed','is-admin');
    btnSaveProgress.style.display='none';
    lblLoadProgress.style.display='none';
    buildUnitPicker();
    screenHistory.length=0;
    backBtn.style.display='none';
    $('#screenUnit').classList.remove('hide');
    return;
  }
  if(which==='role'){
    role=null;user=null;whoPill.textContent='Not signed in';
    document.body.classList.remove('is-authed','is-admin');
    btnSaveProgress.style.display='none';
    lblLoadProgress.style.display='none';
    $('#screenRole').classList.remove('hide');
    return;
  }
  if(which==='viewer'){ buildViewer(); $('#screenViewer').classList.remove('hide'); return; }
  if(which==='staffAuth'){
    $('#screenAuth').classList.remove('hide');
    $('#staffAuth').classList.remove('hide');
    $('#chiefAuth').classList.add('hide');
    $('#adminAuth').classList.add('hide');
    return;
  }
  if(which==='chiefAuth'){
    $('#screenAuth').classList.remove('hide');
    $('#chiefAuth').classList.remove('hide');
    $('#staffAuth').classList.add('hide');
    $('#adminAuth').classList.add('hide');
    return;
  }
  if(which==='adminAuth'){
    $('#screenAuth').classList.remove('hide');
    $('#adminAuth').classList.remove('hide');
    $('#staffAuth').classList.add('hide');
    $('#chiefAuth').classList.add('hide');
    if (typeof reloadUnits === 'function') reloadUnits();
    return;
  }
  if(which==='adminReset'){
    $('#screenAuth').classList.remove('hide');
    $('#adminReset').classList.remove('hide');
    $('#adminAuth').classList.add('hide');
    $('#staffAuth').classList.add('hide');
    $('#chiefAuth').classList.add('hide');
    return;
  }
  if(which==='staff'){ $('#screenStaff').classList.remove('hide'); $('#askAIModule')?.classList.remove('hide'); return; }
  if(which==='chief'){ $('#screenChief').classList.remove('hide'); $('#askAIModule')?.classList.remove('hide'); return; }
  if(which==='admin'){ buildAdmin(); $('#screenAdmin').classList.remove('hide'); return; }
  if(which.startsWith('mod')) $('#'+which).classList.remove('hide');
}
$('#btnUnitGo').addEventListener('click', ()=>{
  const unit=$('#unitSelectHome').value;
  if(!unit) return alert('Select a unit');
  db=load(unit);
  show('role');
});
$('#screenRole').addEventListener('click', e=>{
  const card=e.target.closest('[data-role]'); if(!card) return;
  const r=card.dataset.role;
  if(r==='viewer'){ role='viewer'; whoPill.textContent='Viewer'; buildViewer(); show('viewer'); }
  if(r==='staff'){ role='staff'; whoPill.textContent='Staff ‚Äî sign in'; show('staffAuth'); }
  if(r==='chief'){ role='chief'; whoPill.textContent='PAO Chief ‚Äî sign in'; show('chiefAuth'); }
  if(r==='admin'){ role='admin'; whoPill.textContent='Register ‚Äî sign in'; show('adminAuth'); }
});

/* ================= HAMBURGER ================= */
function buildMenu(){
  menuItems.innerHTML='';
  const items=[
    {id:'staff', label:'My Inputs (core metrics)', dot:'grad1', group:'Staff'},
    {id:'kle', label:'Community Engagement / KLE', dot:'grad1', group:'Staff'},
    {id:'media', label:'Media Log & Queries', dot:'grad2', group:'Staff'},
    {id:'social', label:'Social Media', dot:'grad3', group:'Staff'},
    {id:'brand', label:'Branding Governance', dot:'grad1', group:'Staff'},
    {id:'check', label:'Pre‚ÄëRelease Checklist', dot:'grad2', group:'Staff'},
    {id:'rpie', label:'R-PIE Planner', dot:'grad1', group:'Staff'},
    ...(role==='chief' ? [{id:'chief', label:'PAO Chief (Goals & Staff)', dot:'grad2', group:'PAO Chief'}] : []),
    ...(role==='admin' ? [{id:'admin', label:'Register (Manage Units)', dot:'grad2', group:'Register'}] : []),
    ...(role ? [{id:'signout', label:'Sign out', dot:'grad1'}] : [])
  ];
  const groups={}; const ungrouped=[];
  items.forEach(it=>{ if(it.group) (groups[it.group] ||= []).push(it); else ungrouped.push(it); });
  const createItem=it=>{
    const el=document.createElement('div');
    el.className='menuItem';
    el.innerHTML=`<div class="dot ${it.dot}"></div><div>${it.label}</div>`;
    el.addEventListener('click', ()=>{
      drawer.classList.remove('open');
      if(it.id==='staff') { buildStaff(); show('staff'); }
      if(it.id==='kle') { buildKLE(); show('modKLE'); }
      if(it.id==='media'){ buildMedia(); show('modMedia'); }
      if(it.id==='social'){ buildSocial(); show('modSocial'); }
      if(it.id==='brand'){ buildBrand(); show('modBrand'); }
      if(it.id==='check'){ buildChecklist(); show('modChecklist'); }
      if(it.id==='rpie'){ show('modRpie'); }
      if(it.id==='chief'){ buildChief(); show('chief'); }
      if(it.id==='admin'){ buildAdmin(); show('admin'); }
      if(it.id==='signout'){ window.supabase?.auth.signOut(); show('unit'); }
    });
    return el;
  };
  Object.entries(groups).forEach(([g, list])=>{
    const wrap=document.createElement('div');
    const hdr=document.createElement('div'); hdr.className='menuGroupHeader'; hdr.textContent=g;
    const cont=document.createElement('div'); cont.className='menuGroupItems';
    list.forEach(it=> cont.appendChild(createItem(it)));
    hdr.addEventListener('click', ()=> cont.classList.toggle('hide'));
    wrap.appendChild(hdr); wrap.appendChild(cont); menuItems.appendChild(wrap);
  });
  ungrouped.forEach(it=> menuItems.appendChild(createItem(it)));
}
$('#btnHamburger').addEventListener('click', ()=>{ buildMenu(); drawer.classList.add('open'); });
$$('#drawerClose, #drawerCloseBtn').forEach(el =>
  el.addEventListener('click', () => drawer.classList.remove('open'))
);

/* ================= METRICS CORE LOGIC ================= */
function tbl(container, rows, cols){
  const t=['<table class="table"><thead><tr>']; cols.forEach(c=> t.push(`<th>${c.label}</th>`)); t.push('</tr></thead><tbody>');
  rows.forEach(r=>{ t.push('<tr>'); cols.forEach(c=> t.push(`<td>${c.render(r)}</td>`)); t.push('</tr>'); });
  t.push('</tbody></table>'); container.innerHTML=t.join('');
}
function calcProgress(tf, tfKey, userId, campaignId){
  const g=db.goals[tf];
  const entries=db.entries.filter(e=> e.tf===tf && e.tfKey===tfKey && (!userId || e.userId===userId) && (!campaignId || e.data.campaign===campaignId));
  const outSum=entries.filter(e=>e.type==='output').reduce((m,e)=> (m[e.data.product]=(m[e.data.product]||0)+e.data.qty, m),{});
  const otkSum=entries.filter(e=>e.type==='outtake').reduce((m,e)=> (m[e.data.kind]=(m[e.data.kind]||0)+e.data.qty, m),{});
  const outGoal=g.outputs||{}, otkGoal=g.outtakes||{}, ocmGoal=g.outcomes||{};
  const outTotGoal=sum(outGoal), otkTotGoal=sum(otkGoal);
  const outTotDone=Object.entries(outGoal).reduce((S,[k,v])=> S + Math.min(outSum[k]||0, v||0), 0);
  const otkTotDone=Object.entries(otkGoal).reduce((S,[k,v])=> S + Math.min(otkSum[k]||0, v||0), 0);
  const outPct = outTotGoal? outTotDone/outTotGoal : 0;
  const otkPct = otkTotGoal? otkTotDone/otkTotGoal : 0;
  const metrics=Object.keys(ocmGoal);
  const latestByMetric={};
  entries.filter(e=>e.type==='outcome').forEach(e=> latestByMetric[e.data.metric]=Math.max(latestByMetric[e.data.metric]||0, e.data.pct||0));
  const ocmPct = metrics.length? metrics.reduce((a,m)=>{
    const goal=ocmGoal[m]||0; if(!goal) return a;
    const done=Math.min(latestByMetric[m]||0, goal);
    return a + (goal? done/goal : 0);
  },0)/metrics.length : 0;
  return { outPct, otkPct, ocmPct, outTotals:{done:outTotDone, goal:outTotGoal}, otkTotals:{done:otkTotDone, goal:otkTotGoal}, outBreak:{sum:outSum, goal:outGoal}, otkBreak:{sum:otkSum, goal:otkGoal}, metrics };
}

/* ===== Viewer ===== */
const tfViewerSel=$('#tfViewer'), tfViewerPick=$('#tfViewerPick');
tfViewerSel?.addEventListener('change', ()=> buildTfPicker(tfViewerPick, tfViewerSel.value, key=>{ cur.tf=tfViewerSel.value; cur.key=key; refreshViewer(); }));
function buildTfPicker(spanEl, tf, onChange){
  spanEl.innerHTML=''; const today=new Date();
  if(tf==='M'){ const i=document.createElement('input'); i.type='month'; i.className='input'; i.style.width='auto'; i.value=monthKey(today); i.addEventListener('change', ()=>onChange(i.value)); spanEl.appendChild(i); onChange(i.value); }
  if(tf==='Q'){ const y=document.createElement('input'); y.type='number'; y.className='input'; y.style.width='100px'; y.value=year(today);
    const q=document.createElement('select'); q.className='input'; q.style.width='auto'; ['Q1','Q2','Q3','Q4'].forEach((qq,i)=>{const o=document.createElement('option'); o.value=`Q${i+1}`; o.textContent=qq; q.appendChild(o);}); q.value=`Q${quarter(today)}`;
    const wrap=document.createElement('span'); wrap.appendChild(y); wrap.appendChild(q); spanEl.appendChild(wrap);
    const fire=()=>onChange(`${y.value}-${q.value}`); y.addEventListener('input',fire); q.addEventListener('change',fire); fire(); }
  if(tf==='Y'){ const y=document.createElement('input'); y.type='number'; y.className='input'; y.style.width='100px'; y.value=year(today); y.addEventListener('input', ()=>onChange(String(y.value))); spanEl.appendChild(y); onChange(String(y.value)); }
}
function buildViewer(){
  loadCampaigns();
  buildTfPicker(tfViewerPick, tfViewerSel.value, key=>{cur.key=key; refreshViewer();});
}
function refreshViewer(){
  const p=calcProgress(cur.tf, cur.key);
  $('#sumOutPct').textContent=toPct(p.outPct); $('#sumOutCounts').textContent=`${p.outTotals.done} / ${p.outTotals.goal}`;
  $('#sumOtkPct').textContent=toPct(p.otkPct); $('#sumOtkCounts').textContent=`${p.otkTotals.done} / ${p.otkTotals.goal}`;
  $('#sumOcmPct').textContent=toPct(p.ocmPct); $('#sumOcmCounts').textContent=p.metrics.length? `${p.metrics.length} metrics` : '‚Äî';
  const outRows=Object.keys(p.outBreak.goal).map(k=>({product:k, goal:p.outBreak.goal[k]||0, done:p.outBreak.sum[k]||0}));
  const otkRows=Object.keys(p.otkBreak.goal).map(k=>({kind:k, goal:p.otkBreak.goal[k]||0, done:p.otkBreak.sum[k]||0}));
  tbl($('#tblOutputs'), outRows, [
    {label:'Product', render:r=>r.product},{label:'Goal', render:r=>r.goal},{label:'Done', render:r=>r.done},{label:'% Complete', render:r=> toPct(r.goal? r.done/r.goal : 0)}
  ]);
  tbl($('#tblOuttakes'), otkRows, [
    {label:'Type', render:r=>r.kind},{label:'Goal', render:r=>r.goal},{label:'Done', render:r=>r.done},{label:'% Complete', render:r=> toPct(r.goal? r.done/r.goal : 0)}
  ]);
  const links=db.entries.filter(e=> e.tf===cur.tf && e.tfKey===cur.key && e.type==='output').flatMap(e=> (e.data.links||[]).map(u=>({u,who:db.staff.find(s=>s.id===e.userId)?.name||'Unknown', prod:e.data.product})));
  $('#allLinks').innerHTML = links.length? links.map(l=> `<div class="card" style="background:#0e1124;border-color:#2f355e"><a target="_blank" rel="noopener" href="${l.u}">${l.u}</a><div class="mini">by ${l.who} ‚Ä¢ ${l.prod}</div></div>`).join('') : '<div class="mini">No links submitted yet.</div>';
  function leaders(type, field){
    const arr=db.entries.filter(e=> e.tf===cur.tf && e.tfKey===cur.key && e.type===type);
    const map={}; arr.forEach(e=> map[e.userId]=(map[e.userId]||0)+(e.data[field]||0));
    return Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3).map(([id,v])=> `${db.staff.find(s=>s.id===id)?.name||'‚Äî'} (${v})`).join(', ') || '‚Äî';
  }
  $('#leadersOut').textContent=leaders('output','qty');
  $('#leadersOtk').textContent=leaders('outtake','qty');
  const metrics=Object.keys(db.goals[cur.tf].outcomes||{}); const byUser={};
  db.entries.filter(e=> e.tf===cur.tf && e.tfKey===cur.key && e.type==='outcome').forEach(e=>{ byUser[e.userId]=byUser[e.userId]||{}; byUser[e.userId][e.data.metric]=Math.max(byUser[e.userId][e.data.metric]||0, e.data.pct||0); });
  const lead=Object.entries(byUser).map(([id,obj])=>{ const avg = metrics.length? metrics.reduce((a,m)=> a+(obj[m]||0),0)/metrics.length : 0; return {name:db.staff.find(s=>s.id===id)?.name||'‚Äî', avg}; }).sort((a,b)=>b.avg-a.avg).slice(0,3).map(x=> `${x.name} (${Math.round(x.avg)}%)`).join(', ') || '‚Äî';
  $('#leadersOcm').textContent=lead;
  refreshCampaignProgress();
}

/* ===== Staff ===== */
const tfStaffSel=$('#tfStaff'), tfStaffPick=$('#tfStaffPick');
tfStaffSel?.addEventListener('change', ()=> buildTfPicker(tfStaffPick, tfStaffSel.value, key=>{cur.tf=tfStaffSel.value; cur.key=key; refreshStaff();}));
const staffCampaignSel=$('#staffCampaign');
staffCampaignSel?.addEventListener('change', ()=>{
  const val=staffCampaignSel.value;
  ['outCampaign','otkCampaign','ocmCampaign'].forEach(id=>{ const el=$('#'+id); if(el) el.value=val; });
  const metrics=$('#staffMetrics');
  metrics.style.display = val ? '' : 'none';
  const clr = campaigns.find(c=> c.id==val)?.color || '';
  document.querySelectorAll('#staffMetrics .card, #staffProgress').forEach(card=>{
    if(clr) card.style.borderColor=clr; else card.style.removeProperty('border-color');
  });
  refreshStaff();
});
function buildStaff(){
  loadCampaigns();
  // populate pickers
  const outTemplates = uniqByName([...(def.templates.outputs||[]), ...(db.templates.outputs||[])]);
  $('#outTemplate').innerHTML = `<option value="">Select template</option>` + outTemplates.map(t=>`<option>${t.name}</option>`).join('');
  $('#outProdType').innerHTML = getOutputNames().concat('Other (specify)').map(t=>`<option>${t}</option>`).join('');
  const otkTemplates = uniqByName([...(def.templates.outtakes||[]), ...(db.templates.outtakes||[])]);
  $('#otkTemplate').innerHTML = `<option value="">Select template</option>` + otkTemplates.map(t=>`<option>${t.name}</option>`).join('');
  $('#otkType').innerHTML    = getOuttakeNames().concat('Other (specify)').map(t=>`<option>${t}</option>`).join('');
  const sel=$('#ocmKey');
  const outcomeNames = getOutcomeNames();
  sel.innerHTML = [...outcomeNames, 'Other (specify)'].map(o=>`<option>${o}</option>`).join('');
  buildTfPicker(tfStaffPick, tfStaffSel.value, key=>{cur.key=key; refreshStaff();});
  if(staffCampaignSel){ staffCampaignSel.value=''; $('#staffMetrics').style.display='none'; }
}
$('#outProdType').addEventListener('change', ()=> $('#otherProdWrap').classList.toggle('hide', $('#outProdType').value!=='Other (specify)'));
$('#otkType').addEventListener('change', ()=> $('#otkOtherWrap').classList.toggle('hide', $('#otkType').value!=='Other (specify)'));
$('#ocmKey').addEventListener('change', ()=> $('#ocmOtherWrap').classList.toggle('hide', $('#ocmKey').value!=='Other (specify)'));
$('#ocmKey').dispatchEvent(new Event('change'));
const findOutputTemplate=name=>[...(def.templates.outputs||[]), ...(db.templates.outputs||[])]
  .find(o=>o.name===name);
$('#outTemplate').addEventListener('change', ()=>{
  const t=findOutputTemplate($('#outTemplate').value);
  if(t){
    $('#outProdType').value=t.name;
    $('#outQty').value=t.qty||1;
    $('#outLinks').value=(t.links||[]).join('\n');
    $('#outProdType').dispatchEvent(new Event('change'));
  }
});
const findOuttakeTemplate=name=>[...(def.templates.outtakes||[]), ...(db.templates.outtakes||[])]
  .find(o=>o.name===name);
$('#otkTemplate').addEventListener('change', ()=>{
  const t=findOuttakeTemplate($('#otkTemplate').value);
  if(t){
    $('#otkType').value=t.name;
    $('#otkQty').value=t.qty||1;
    $('#otkNotes').value=t.notes||'';
    $('#otkType').dispatchEvent(new Event('change'));
  }
});
$('#ocmPct').addEventListener('input', e=> $('#ocmVal').textContent = e.target.value+'%');
$('#btnAddOutput').addEventListener('click', ()=>{
  if(!user) return; const type=$('#outProdType').value==='Other (specify)' ? ($('#otherProd').value.trim()||'Other') : $('#outProdType').value;
  const qty=parseInt($('#outQty').value||'0',10); if(qty<=0) return alert('Quantity must be > 0');
  const links=parseLinks($('#outLinks').value);
  const campaign=$('#outCampaign').value||null;
  const entry={id:uid(), userId:user.id, type:'output', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{product:type, qty, links, campaign}};
  db.entries.push(entry);
  save(); saveEntryToSupabase(entry); $('#outQty').value=1; $('#outLinks').value=''; $('#otherProd').value=''; refreshStaff(); refreshViewerIf();
});
$('#btnClearOutput').addEventListener('click', ()=>{ $('#outQty').value=1; $('#outLinks').value=''; $('#otherProd').value=''; });
$('#btnAddOuttake').addEventListener('click', ()=>{
  if(!user) return; const type=$('#otkType').value==='Other (specify)' ? ($('#otkOther').value.trim()||'Other') : $('#otkType').value;
  const qty=parseInt($('#otkQty').value||'0',10); if(qty<=0) return alert('Quantity must be > 0');
  const notes=$('#otkNotes').value.trim();
  const campaign=$('#otkCampaign').value||null;
  const entry={id:uid(), userId:user.id, type:'outtake', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{kind:type, qty, notes, campaign}};
  db.entries.push(entry);
  save(); saveEntryToSupabase(entry); $('#otkQty').value=1; $('#otkNotes').value=''; $('#otkOther').value=''; refreshStaff(); refreshViewerIf();
});
$('#btnClearOuttake').addEventListener('click', ()=>{ $('#otkQty').value=1; $('#otkNotes').value=''; $('#otkOther').value=''; });
$('#btnSaveOutcome').addEventListener('click', ()=>{
  if(!user) return;
  const key=$('#ocmKey').value==='Other (specify)' ? ($('#ocmOther').value.trim()||'Other') : $('#ocmKey').value;
  if(!key) return alert('No outcome metric defined.');
  const pct=parseInt($('#ocmPct').value,10);
  const campaign=$('#ocmCampaign').value||null;
  const entry={id:uid(), userId:user.id, type:'outcome', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{metric:key, pct, campaign}};
  db.entries.push(entry);
  save(); saveEntryToSupabase(entry); $('#ocmOther').value=''; refreshStaff(); refreshViewerIf();
});
function refreshStaff(){
  const campaign=$('#staffCampaign')?.value;
  if(!campaign){
    ['outList','otkList','ocmList'].forEach(id=>{ const el=$('#'+id); if(el) el.innerHTML=''; });
    ['kpiOutPct','kpiOtkPct','kpiOcmPct'].forEach(id=>{ const el=$('#'+id); if(el) el.textContent='0%'; });
    return;
  }
  const campClr = campaigns.find(c=> c.id==campaign)?.color || '#2f355e';
  const mine=db.entries.filter(e=> e.userId===user?.id && e.tf===cur.tf && e.tfKey===cur.key && e.data.campaign===campaign);
  const outs=mine.filter(e=>e.type==='output').sort((a,b)=>b.ts-a.ts), otks=mine.filter(e=>e.type==='outtake').sort((a,b)=>b.ts-a.ts), ocms=mine.filter(e=>e.type==='outcome').sort((a,b)=>b.ts-a.ts);
  $('#outList').innerHTML = outs.length? outs.map(e=> {
    const links=(e.data.links||[]).map(u=> `<a href="${u}" target="_blank" rel="noopener">${u}</a>`).join('<br>');
    return `<div class="card" style="background:#0e1124;border-color:${campClr}"><div class="chip mono">${e.data.qty}√ó</div> <span class="chip">${e.data.product}</span>${links?'<div class="divider"></div><div class="links">'+links+'</div>':''}<div class="mini">${new Date(e.ts).toLocaleString()}</div></div>`;
  }).join('') : '<div class="mini">No outputs yet.</div>';
  $('#otkList').innerHTML = otks.length? otks.map(e=> `<div class="card" style="background:#0e1124;border-color:${campClr}"><div class="chip mono">${e.data.qty}√ó</div> <span class="chip">${e.data.kind}</span>${e.data.notes?'<div class="divider"></div><div class="mini">'+e.data.notes+'</div>':''}<div class="mini">${new Date(e.ts).toLocaleString()}</div></div>`).join('') : '<div class="mini">No outtakes yet.</div>';
  $('#ocmList').innerHTML = ocms.length? ocms.map(e=> `<div class="card" style="background:#0e1124;border-color:${campClr}"><span class="chip">${e.data.metric}</span><div class="divider"></div><div class="mini">${clamp(e.data.pct,0,100)}% ‚Ä¢ ${new Date(e.ts).toLocaleString()}</div></div>`).join('') : '<div class="mini">No outcomes yet.</div>';
  const p=calcProgress(cur.tf, cur.key, user?.id, campaign); $('#kpiOutPct').textContent=toPct(p.outPct); $('#kpiOtkPct').textContent=toPct(p.otkPct); $('#kpiOcmPct').textContent=toPct(p.ocmPct);
}
function refreshViewerIf(){ if(!$('#screenViewer').classList.contains('hide')) refreshViewer(); }

/* ===== PAO Chief ===== */
const tfChiefSel=$('#tfChief'), tfChiefPick=$('#tfChiefPick');
tfChiefSel?.addEventListener('change', ()=> buildTfPicker(tfChiefPick, tfChiefSel.value, key=>{cur.tf=tfChiefSel.value; cur.key=key; buildGoalsEditors(); refreshChiefDash();}));
function buildChief(){
  buildTfPicker(tfChiefPick, tfChiefSel.value, key=>{cur.key=key; buildGoalsEditors(); refreshChiefDash();});
  renderStaffList();
  loadCampaigns();
  if(db.apiKeys){
    $('#apiKeyFacebook').value = db.apiKeys.facebook || '';
    $('#apiKeyInstagram').value = db.apiKeys.instagram || '';
    $('#apiKeyX').value = db.apiKeys.x || '';
    $('#apiKeyLinkedin').value = db.apiKeys.linkedin || '';
  }
  $('#btnSaveApiKeys').onclick=()=>{
    if(!db.apiKeys) db.apiKeys = {};
    db.apiKeys.facebook = $('#apiKeyFacebook').value.trim();
    db.apiKeys.instagram = $('#apiKeyInstagram').value.trim();
    db.apiKeys.x = $('#apiKeyX').value.trim();
    db.apiKeys.linkedin = $('#apiKeyLinkedin').value.trim();
    save();
    alert('API Keys saved');
  };
}
  $('#btnAddStaff').onclick=()=>{
    const name=$('#staffName').value.trim();
    if(!name) return alert('Name required');
    let rec=db.staff.find(s=>s.name.toLowerCase()===name.toLowerCase());
    if(!rec) db.staff.push({id:uid(),name});
    save();
    $('#staffName').value='';
    renderStaffList();
  };
  $('#btnExport').onclick=()=>{ const blob=new Blob([JSON.stringify(db,null,2)],{type:'application/json'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='nww_pao_metrics_export.json'; a.click(); };
  $('#importFile').onchange=(e)=>{ const f=e.target.files[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ db=JSON.parse(fr.result); save(); alert('Imported. Reloading‚Ä¶'); location.reload(); }catch(err){ alert('Invalid JSON'); } }; fr.readAsText(f); };
$('#btnReset').onclick=()=>{ if(!confirm('Wipe all local data?'))return; localStorage.clear(); location.reload(); };
function renderStaffList(){
  const box=$('#staffList'); box.innerHTML=''; if(!db.staff.length){ box.innerHTML='<div class="mini">No staff yet.</div>'; return; }
  db.staff.forEach(s=>{
    const row=document.createElement('div'); row.className='card'; row.style.cssText='background:#0e1124;border-color:#2f355e;display:flex;justify-content:space-between;align-items:center;gap:8px;';
    row.innerHTML=`<div><strong>${s.name}</strong><div class="mini">id: ${s.id}</div></div><div><button class="danger small" data-del="${s.id}">Remove</button></div>`;
    box.appendChild(row);
  });
  box.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', e=>{ const id=e.target.dataset.del; if(!confirm('Remove staff?'))return; db.staff=db.staff.filter(x=>x.id!==id); save(); renderStaffList(); }));
}

$('#btnStaffLogin').onclick=()=>{
  const email=$('#staff-email').value;
  const password=$('#staff-pass').value;
  nwwSignIn(email, password);
};

$('#btnChiefLogin').onclick=()=>{
  const email=$('#chief-email').value;
  const password=$('#chief-pass').value;
  nwwSignIn(email, password);
};

function enableEnterSubmission(inputs, btnSel){
  const btn=$(btnSel);
  inputs.forEach(sel=>{
    const el=$(sel);
    el?.addEventListener('keydown', e=>{
      if(e.key==='Enter'){
        e.preventDefault();
        btn?.click();
      }
    });
  });
}

enableEnterSubmission(['#si-email','#si-pass'], '#btnAdminSignIn');
enableEnterSubmission(['#su-email','#su-pass','#su-confirm'], '#btnAdminSignUp');
enableEnterSubmission(['#chief-email','#chief-pass'], '#btnChiefLogin');
enableEnterSubmission(['#staff-email','#staff-pass'], '#btnStaffLogin');
enableEnterSubmission(['#outTemplate','#outProdType','#otherProd','#outQty','#outCampaign'], '#btnAddOutput');
enableEnterSubmission(['#otkTemplate','#otkType','#otkOther','#otkQty','#otkCampaign'], '#btnAddOuttake');
enableEnterSubmission(['#ocmKey','#ocmOther','#ocmPct','#ocmCampaign'], '#btnSaveOutcome');

$('#btnSaveCampaign').onclick=async()=>{
  const name=$('#cmpName').value.trim();
  const code=$('#cmpCode').value.trim();
  const color=$('#cmpColor').value;
  const position=parseInt($('#cmpPosition').value||'0',10);
  const is_active=$('#cmpActive').checked;
  const { error } = await supabase.rpc('upsert_campaign', { id: editCampaignId, name, code, color, position, is_active });
  if(error) return alert(error.message);
  editCampaignId=null; $('#cmpName').value=''; $('#cmpCode').value=''; $('#cmpColor').value='#000000'; $('#cmpPosition').value='0'; $('#cmpActive').checked=true;
  loadCampaigns();
};

$('#btnSaveCampaignGoal').onclick=async()=>{
  const campaign_code=$('#goalCampaign').value;
  const kind=$('#goalKind').value;
  const label=$('#goalLabel').value.trim();
  const target=parseInt($('#goalTarget').value||'0',10);
  const timeframe=$('#goalTimeframe').value;
  const { error } = await supabase.rpc('upsert_goal', { campaign_code, kind, label, target, timeframe });
  if(error) return alert(error.message);
  $('#goalLabel').value=''; $('#goalTarget').value='0';
  refreshCampaignProgress();
};

function buildGoalsEditors(){
  const g=db.goals[cur.tf];
  // Outputs setup
  const outSel=$('#outSel'), outOther=$('#outOther'), outRange=$('#outRange'), outVal=$('#outVal');
  const outNames=getOutputNames();
  outSel.innerHTML = outNames.map(n=>`<option>${n}</option>`).join('') + '<option value="__other">Other</option>';
  outSel.value=''; outOther.style.display='none';
  outSel.onchange=()=>{ outOther.style.display = outSel.value==='__other'? '' : 'none'; };
  outRange.oninput=()=> outVal.textContent=outRange.value;
  $('#addOut').onclick=()=>{
    const name=outSel.value==='__other'? outOther.value.trim() : outSel.value;
    if(!name) return alert('Metric name required.');
    g.outputs[name]=parseInt(outRange.value,10)||0;
    outOther.value=''; outSel.value=''; outRange.value=0; outVal.textContent='0';
    renderOutTable();
  };
  function renderOutTable(){
    const rows=Object.entries(g.outputs||{}).map(([metric,goal])=>({metric,goal}));
    tbl($('#outTable'), rows, [
      {label:'Metric',render:r=>r.metric},
      {label:'Goal',render:r=>r.goal},
      {label:'',render:r=>`<button class="danger small" data-del="${r.metric}">Remove</button>`}
    ]);
    $('#outTable').querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', e=>{ delete g.outputs[e.target.dataset.del]; renderOutTable(); }));
  }
  renderOutTable();

  // Outtakes setup
  const otkSel=$('#otkSel'), otkOther=$('#otkOtherGoal'), otkRange=$('#otkRange'), otkVal=$('#otkVal');
  const otkNames=getOuttakeNames();
  otkSel.innerHTML = otkNames.map(n=>`<option>${n}</option>`).join('') + '<option value="__other">Other</option>';
  otkSel.value=''; otkOther.style.display='none';
  otkSel.onchange=()=>{ otkOther.style.display = otkSel.value==='__other'? '' : 'none'; };
  otkRange.oninput=()=> otkVal.textContent=otkRange.value;
  $('#addOtk').onclick=()=>{
    const name=otkSel.value==='__other'? otkOther.value.trim() : otkSel.value;
    if(!name) return alert('Metric name required.');
    g.outtakes[name]=parseInt(otkRange.value,10)||0;
    otkOther.value=''; otkSel.value=''; otkRange.value=0; otkVal.textContent='0';
    renderOtkTable();
  };
  function renderOtkTable(){
    const rows=Object.entries(g.outtakes||{}).map(([metric,goal])=>({metric,goal}));
    tbl($('#otkTable'), rows, [
      {label:'Metric',render:r=>r.metric},
      {label:'Goal',render:r=>r.goal},
      {label:'',render:r=>`<button class="danger small" data-del="${r.metric}">Remove</button>`}
    ]);
    $('#otkTable').querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', e=>{ delete g.outtakes[e.target.dataset.del]; renderOtkTable(); }));
  }
  renderOtkTable();

  // Outcomes setup
  const ocmSel=$('#ocmSel'), ocmOther=$('#ocmOtherGoal'), ocmRange=$('#ocmRange'), ocmVal=$('#ocmVal');
  const outcomeNames=getOutcomeNames();
  ocmSel.innerHTML = outcomeNames.map(n=>`<option>${n}</option>`).join('') + '<option value="__other">Other</option>';
  ocmSel.value=''; ocmOther.style.display='none';
  ocmSel.onchange=()=>{ ocmOther.style.display = ocmSel.value==='__other'? '' : 'none'; };
  ocmRange.oninput=()=> ocmVal.textContent=`${ocmRange.value}%`;
  $('#addOcm').onclick=()=>{
    const name=ocmSel.value==='__other'? ocmOther.value.trim() : ocmSel.value;
    if(!name) return alert('Metric name required.');
    g.outcomes[name]=parseInt(ocmRange.value,10)||0;
    ocmOther.value=''; ocmSel.value=''; ocmRange.value=0; ocmVal.textContent='0%';
    renderOcmTable();
  };
  function renderOcmTable(){
    const rows=Object.entries(g.outcomes||{}).map(([metric,goal])=>({metric,goal}));
    tbl($('#ocmTable'), rows, [
      {label:'Metric',render:r=>r.metric},
      {label:'Goal',render:r=>`${r.goal}%`},
      {label:'',render:r=>`<button class="danger small" data-del="${r.metric}">Remove</button>`}
    ]);
    $('#ocmTable').querySelectorAll('[data-del]').forEach(btn=> btn.addEventListener('click', e=>{ delete g.outcomes[e.target.dataset.del]; renderOcmTable(); }));
  }
  renderOcmTable();
}
$('#btnSaveGoals')?.addEventListener('click', ()=>{ save(); alert('Goals saved'); refreshChiefDash(); });
function refreshChiefDash(){
  const p=calcProgress(cur.tf, cur.key);
  $('#chiefOutPct').textContent=toPct(p.outPct); $('#chiefOutCounts').textContent=`${p.outTotals.done} / ${p.outTotals.goal}`;
  $('#chiefOtkPct').textContent=toPct(p.otkPct); $('#chiefOtkCounts').textContent=`${p.otkTotals.done} / ${p.otkTotals.goal}`;
  $('#chiefOcmPct').textContent=toPct(p.ocmPct); $('#chiefOcmCounts').textContent=Object.keys(db.goals[cur.tf].outcomes||{}).length? `${Object.keys(db.goals[cur.tf].outcomes||{}).length} metrics`:'‚Äî';
  const outRows=Object.keys(p.outBreak.goal).map(k=>({product:k, goal:p.outBreak.goal[k]||0, done:p.outBreak.sum[k]||0}));
  const otkRows=Object.keys(p.otkBreak.goal).map(k=>({kind:k, goal:p.otkBreak.goal[k]||0, done:p.otkBreak.sum[k]||0}));
  tbl($('#chiefTblOutputs'), outRows, [{label:'Product',render:r=>r.product},{label:'Goal',render:r=>r.goal},{label:'Done',render:r=>r.done},{label:'% Complete',render:r=> toPct(r.goal? r.done/r.goal : 0)}]);
  tbl($('#chiefTblOuttakes'), otkRows, [{label:'Type',render:r=>r.kind},{label:'Goal',render:r=>r.goal},{label:'Done',render:r=>r.done},{label:'% Complete',render:r=> toPct(r.goal? r.done/r.goal : 0)}]);
}

function buildAdmin(){
  const sel=$('#adminUnit'); const list=$('#unitList');
  sel.innerHTML=''; list.innerHTML='';
  const units=JSON.parse(localStorage.getItem(UNITS_KEY)||'[]');
  units.forEach(u=>{
    const o=document.createElement('option'); o.value=u; o.textContent=u; sel.appendChild(o);
    const row=document.createElement('div');
    row.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;';
    row.innerHTML=`<div>${u}</div><div><button class="ghost small" data-edit="${u}">Rename</button> <button class="danger small" data-del="${u}">Delete</button></div>`;
    list.appendChild(row);
  });
  sel.value=currentUnit;
  sel.onchange=e=>{ db=load(e.target.value); buildAdmin(); };

  const newChiefUnitSel=$('#adminNewChiefUnit');
  if(newChiefUnitSel){
    newChiefUnitSel.innerHTML='';
    units.forEach(u=>{ const o=document.createElement('option'); o.value=u; o.textContent=u; newChiefUnitSel.appendChild(o); });
    newChiefUnitSel.value=currentUnit;
  }
  const chiefList=$('#chiefAdminList');
  if(chiefList){
    const chiefs=loadChiefs();
    chiefList.innerHTML='';
    chiefs.forEach(c=>{
      const row=document.createElement('div');
      row.style.cssText='display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;';
      row.innerHTML=`<div>${c.name}</div><div><button class="danger small" data-del="${c.id}">Remove</button></div>`;
      chiefList.appendChild(row);
    });
    chiefList.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', e=>{
      const id=e.target.dataset.del; if(!confirm('Remove chief?')) return; let chiefs=loadChiefs().filter(x=>x.id!==id); saveChiefs(chiefs); if(db.chiefId===id){ db.chiefId=null; save(); } buildAdmin();
    }));
  }
  list.querySelectorAll('[data-edit]').forEach(b=> b.addEventListener('click', e=>{
    const old=e.target.dataset.edit;
    const neu=prompt('Rename unit', old);
    if(!neu || neu===old) return;
    const units=JSON.parse(localStorage.getItem(UNITS_KEY)||'[]');
    if(units.includes(neu)) return alert('Unit exists');
    const idx=units.indexOf(old); units[idx]=neu; localStorage.setItem(UNITS_KEY, JSON.stringify(units));
    const oldKey=`${STORAGE_KEY_BASE}_${old}`; const data=localStorage.getItem(oldKey);
    if(data!==null){ localStorage.setItem(`${STORAGE_KEY_BASE}_${neu}`, data); localStorage.removeItem(oldKey); }
    if(currentUnit===old) currentUnit=neu;
    buildAdmin(); buildUnitPicker();
  }));
  list.querySelectorAll('[data-del]').forEach(b=> b.addEventListener('click', e=>{
    const unit=e.target.dataset.del;
    if(!confirm('Delete unit '+unit+'?')) return;
    const units=JSON.parse(localStorage.getItem(UNITS_KEY)||'[]').filter(u=>u!==unit);
    localStorage.setItem(UNITS_KEY, JSON.stringify(units));
    localStorage.removeItem(`${STORAGE_KEY_BASE}_${unit}`);
    if(currentUnit===unit){ currentUnit=units[0]||'default'; db=load(currentUnit); }
    buildAdmin(); buildUnitPicker();
  }));

  const aiOpen = $('#adminApiKeyOpenAI');
  if(aiOpen){
    aiOpen.value = aiApiKeys.openai || '';
    $('#adminApiKeyGemini').value = aiApiKeys.gemini || '';
    $('#adminApiKeyCamogpt').value = aiApiKeys.camogpt || '';
    $('#adminApiKeyAsksage').value = aiApiKeys.asksage || '';
    $('#btnAdminSaveAiKeys').onclick = async () => {
      aiApiKeys.openai = $('#adminApiKeyOpenAI').value.trim();
      aiApiKeys.gemini = $('#adminApiKeyGemini').value.trim();
      aiApiKeys.camogpt = $('#adminApiKeyCamogpt').value.trim();
      aiApiKeys.asksage = $('#adminApiKeyAsksage').value.trim();
      saveAiApiKeys();
      const unit_id = CURRENT?.unit_id;
      try {
        if (!window.PAOWeb) throw new Error('PAOWeb module not loaded');
        await Promise.all([
          window.PAOWeb.saveAiKey({ unit_id, provider:'openai', api_key: aiApiKeys.openai, model:null, enabled:!!aiApiKeys.openai }),
          window.PAOWeb.saveAiKey({ unit_id, provider:'gemini', api_key: aiApiKeys.gemini, model:null, enabled:!!aiApiKeys.gemini }),
          window.PAOWeb.saveAiKey({ unit_id, provider:'camogpt', api_key: aiApiKeys.camogpt, model:null, enabled:!!aiApiKeys.camogpt }),
          window.PAOWeb.saveAiKey({ unit_id, provider:'asksage', api_key: aiApiKeys.asksage, model:null, enabled:!!aiApiKeys.asksage })
        ]);
        alert('AI API Keys saved');
      } catch(err) {
        console.error('Failed to save AI API Keys', err);
        alert('Failed to save AI API Keys');
      }
    };
  }
  if (window.PAOWeb?.loadAllUsers) window.PAOWeb.loadAllUsers();
}
$('#btnAdminOpen').onclick=()=>{ const unit=$('#adminUnit').value; if(!unit) return alert('Select unit'); db=load(unit); role='chief'; whoPill.textContent=`PAO Chief (${unit})`; buildChief(); show('chief'); };
$('#btnAdminAddUnit').onclick=()=>{
  const unit=$('#adminNewUnit').value.trim();
  if(!unit) return alert('Enter a unit');
  const units=JSON.parse(localStorage.getItem(UNITS_KEY)||'[]');
  if(units.includes(unit)) return alert('Unit exists');
  localStorage.setItem(`${STORAGE_KEY_BASE}_${unit}`, JSON.stringify(def));
  units.push(unit); localStorage.setItem(UNITS_KEY, JSON.stringify(units));
  $('#adminNewUnit').value='';
  buildAdmin(); buildUnitPicker();
};
$('#btnSaveGlobalPIN').onclick=()=>{ const p=$('#setGlobalPIN').value.trim(); if(!p) return alert('Enter a PIN'); globalAdminPIN=p; localStorage.setItem(GLOBAL_PIN_KEY,p); $('#setGlobalPIN').value=''; alert('Admin PIN updated'); };
$('#btnAdminAddChief').onclick=()=>{
  const name=$('#adminNewChief').value.trim();
  const unit=$('#adminNewChiefUnit').value;
  if(!name||!unit) return alert('Name & Unit required');
  const chiefs=loadChiefs();
  const id=uid();
  chiefs.push({id, name});
  saveChiefs(chiefs);
  const prevUnit=currentUnit;
  db=load(unit);
  db.chiefId=id;
  save();
  db=load(prevUnit);
  $('#adminNewChief').value='';
  buildAdmin();
};

/* ================= MODULES (Hamburger) ================= */
function buildKLE(){
  const c=$('#modKLE');
  c.innerHTML=`
    <div class="card" style="margin-top:18px;background:var(--accent4);color:#041d13">
      <h3>Community Engagement / KLE</h3>
      <div class="grid grid-3">
        <div><label>Date</label><input id="kleDate" class="input" type="date" value="${todayISO()}"></div>
        <div><label>Audience / Partner</label><input id="kleAudience" class="input" placeholder="e.g., County EM, Tribe, City Council"></div>
        <div><label>Purpose</label><input id="klePurpose" class="input" placeholder="e.g., Dam safety update"></div>
        <div><label># Attendees</label><input id="kleAtt" class="input" type="number" min="0" value="0"></div>
        <div><label>Talking Points (bullets)</label><textarea id="kleTP" rows="3" class="input" placeholder="- Point 1&#10;- Point 2"></textarea></div>
        <div><label>Commitments / Follow‚Äëups</label><textarea id="kleCom" rows="3" class="input" placeholder="- Action / POC / due"></textarea></div>
        <div><label>Links (comma or new line)</label><textarea id="kleLinks" rows="2" class="input" placeholder="Agenda, deck, photos‚Ä¶"></textarea></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px"><button class="cta" id="btnKLEAdd">Save KLE</button></div>
    </div>
    <div class="card" style="margin-top:12px"><h3>KLE Log</h3><div id="kleList" class="scroll"></div></div>`;
  $('#btnKLEAdd').onclick=()=>{
    if(!user) return alert('Sign in');
    const rec={id:uid(), by:user.name, date:$('#kleDate').value, audience:$('#kleAudience').value.trim(), purpose:$('#klePurpose').value.trim(), attendees:parseInt($('#kleAtt').value||'0',10), talkingPoints:$('#kleTP').value, commitments:$('#kleCom').value, links:parseLinks($('#kleLinks').value), ts:Date.now()};
    db.kle.push(rec);
    db.entries.push({id:uid(), userId:user.id, type:'outtake', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{kind:'Stakeholder briefings', qty:1, notes:rec.audience}});
    if(rec.attendees>0){ db.entries.push({id:uid(), userId:user.id, type:'outtake', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{kind:'Event attendees', qty:rec.attendees, notes:rec.audience}}); }
    save();
    renderKLE();
    refreshStaff();
    refreshViewerIf();
  };
  renderKLE();
}
function renderKLE(){
  const wrap=$('#kleList'); const rows=[...db.kle].sort((a,b)=>b.ts-a.ts);
  wrap.innerHTML = rows.length? rows.map(r=>`<div class="card" style="background:#0e1124;border-color:#2f355e">
    <div class="chip">${r.date}</div> <span class="chip">${r.audience}</span> <span class="chip">${r.attendees} attendees</span>
    <div class="divider"></div><div class="mini">Purpose: ${r.purpose||'‚Äî'}</div>
    ${r.talkingPoints? `<div class="divider"></div><pre class="mini" style="white-space:pre-wrap">${r.talkingPoints}</pre>`:''}
    ${r.commitments? `<div class="divider"></div><pre class="mini" style="white-space:pre-wrap">${r.commitments}</pre>`:''}
    ${r.links?.length? `<div class="divider"></div><div class="links">${r.links.map(u=>`<a href="${u}" target="_blank">${u}</a>`).join('<br>')}</div>`:''}
    <div class="mini">Logged by ${r.by} ‚Ä¢ ${new Date(r.ts).toLocaleString()}</div></div>`).join('') : '<div class="mini">No KLE entries yet.</div>';
}

function buildMedia(){
  const c=$('#modMedia');
  c.innerHTML=`
    <div class="card" style="margin-top:18px;background:var(--accent2);color:#1d0c16">
      <h3>Media Log & Query Tracker</h3>
      <div class="grid grid-3">
        <div><label>Date</label><input id="medDate" class="input" type="date" value="${todayISO()}"></div>
        <div><label>Outlet</label><input id="medOutlet" class="input" placeholder="e.g., KXLY, Spokesman-Review"></div>
        <div><label>Reporter</label><input id="medReporter" class="input" placeholder="Name"></div>
        <div><label>Topic / Query</label><input id="medTopic" class="input" placeholder="Subject"></div>
        <div><label>Deadline</label><input id="medDeadline" class="input" type="datetime-local"></div>
        <div><label>Status</label><select id="medStatus" class="input"><option>Open</option><option>In Progress</option><option>Responded</option><option>Closed</option></select></div>
        <div><label>Spokesperson</label><input id="medSpox" class="input" placeholder="Name/Title"></div>
        <div><label>Disposition</label><input id="medDisp" class="input" placeholder="Key outcome"></div>
        <div><label>Link to Response / Story</label><input id="medLink" class="input" placeholder="https://‚Ä¶"></div>
        <div class="grid" style="grid-template-columns:1fr auto; align-items:end; gap:10px">
          <div><label>Notes</label><textarea id="medNotes" class="input" rows="3"></textarea></div>
          <button class="cta" id="btnMedSave">Save</button>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:12px"><h3>Media Queries</h3><div id="mediaList" class="scroll"></div></div>`;
  $('#btnMedSave').onclick=()=>{
    if(!user) return alert('Sign in');
    const rec={id:uid(), by:user.name, date:$('#medDate').value, outlet:$('#medOutlet').value.trim(), reporter:$('#medReporter').value.trim(), topic:$('#medTopic').value.trim(), deadline:$('#medDeadline').value, status:$('#medStatus').value, spokesperson:$('#medSpox').value.trim(), disposition:$('#medDisp').value.trim(), link:$('#medLink').value.trim(), notes:$('#medNotes').value.trim(), ts:Date.now()};
    db.media.push(rec);
    db.entries.push({id:uid(), userId:user.id, type:'outtake', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{kind:'Media engagements', qty:1, notes:rec.outlet}});
    save();
    renderMedia();
    refreshStaff();
    refreshViewerIf();
  };
  renderMedia();
}
function renderMedia(){
  const wrap=$('#mediaList'); const rows=[...db.media].sort((a,b)=>b.ts-a.ts);
  wrap.innerHTML = rows.length? rows.map(r=>`<div class="card" style="background:#0e1124;border-color:#2f355e">
    <div class="chip">${r.date}</div> <span class="chip">${r.outlet}</span> <span class="chip">${r.reporter}</span> <span class="chip">${r.status}</span>
    <div class="divider"></div><div class="mini"><strong>Topic:</strong> ${r.topic||'‚Äî'}</div>
    <div class="mini"><strong>Deadline:</strong> ${r.deadline? new Date(r.deadline).toLocaleString():'‚Äî'}</div>
    <div class="mini"><strong>Spokesperson:</strong> ${r.spokesperson||'‚Äî'}</div>
    <div class="mini"><strong>Disposition:</strong> ${r.disposition||'‚Äî'}</div>
    ${r.link? `<div class="links"><a href="${r.link}" target="_blank">Open link</a></div>`:''}
    ${r.notes? `<div class="mini">${r.notes}</div>`:''}
    <div class="mini">Logged by ${r.by} ‚Ä¢ ${new Date(r.ts).toLocaleString()}</div></div>`).join('') : '<div class="mini">No media queries yet.</div>';
}

function buildSocial(){
  const c=$('#modSocial');
  c.innerHTML=`
    <div class="card" style="margin-top:18px;background:var(--accent3);color:#281a07">
      <h3>Social Media Tracker</h3>
      <div class="grid grid-3">
        <div><label>Platform</label><select id="socPlatform" class="input"><option>Facebook</option><option>Instagram</option><option>X</option><option>LinkedIn</option><option>YouTube</option><option>Other</option></select></div>
        <div><label>Handle</label><input id="socHandle" class="input" placeholder="@USACEWallaWalla"></div>
        <div><label>Date/Time (posted)</label><input id="socDT" class="input" type="datetime-local"></div>
        <div><label>Post Type</label><select id="socType" class="input"><option>News link</option><option>Photo</option><option>Video</option><option>Thread</option><option>Story/Reel/Short</option><option>Other</option></select></div>
        <div><label>Public Link</label><input id="socLink" class="input" placeholder="https://‚Ä¶"></div>
        <div><label>Campaign/Focus</label><input id="socCampaign" class="input" placeholder="Deliver the Mission / EWeek"></div>
        <div><label>Reach (optional)</label><input id="socReach" class="input" type="number" min="0" value="0"></div>
        <div><label>Engagements (optional)</label><input id="socEng" class="input" type="number" min="0" value="0"></div>
        <div><label>Notes</label><input id="socNotes" class="input" placeholder="Alt text, captions, tagging‚Ä¶"></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px"><button class="cta" id="btnSocSave">Save Post</button><button class="cta" id="btnSocPostApi" style="display:none; background: var(--accent2);">Post via API</button></div>
    </div>
    <div class="card" style="margin-top:12px"><h3>Social Posts</h3><div id="socList" class="scroll"></div></div>`;
  $('#btnSocSave').onclick=()=>{
    if(!user) return alert('Sign in');
    const rec={id:uid(), by:user.name, datetime:$('#socDT').value, platform:$('#socPlatform').value, handle:$('#socHandle').value.trim(), postType:$('#socType').value, link:$('#socLink').value.trim(), campaign:$('#socCampaign').value.trim(), reach:parseInt($('#socReach').value||'0',10), engagements:parseInt($('#socEng').value||'0',10), notes:$('#socNotes').value.trim(), ts:Date.now()};
    db.social.push(rec);
    const links = rec.link? [rec.link] : [];
    db.entries.push({id:uid(), userId:user.id, type:'output', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{product:'Social media posts', qty:1, links}});
    save();
    renderSocial();
    refreshStaff();
    refreshViewerIf();
  };
  const btnApi = $('#btnSocPostApi');
  if(role === 'chief' && db.apiKeys && Object.values(db.apiKeys).some(k => k)){
      btnApi.style.display = 'inline-block';
  }
  btnApi.onclick = () => {
      const platform = $('#socPlatform').value.toLowerCase();
      if(db.apiKeys && db.apiKeys[platform] && db.apiKeys[platform].length > 0){
          alert('"Posting" to '+$('#socPlatform').value+' via API... (This is a demo)');
          $('#btnSocSave').click();
      } else {
          alert('API key for '+$('#socPlatform').value+' is not configured in PAO Chief settings, or the platform is not supported for API posting.');
      }
  };
  renderSocial();
}
function renderSocial(){
  const wrap=$('#socList'); const rows=[...db.social].sort((a,b)=>b.ts-a.ts);
  wrap.innerHTML = rows.length? rows.map(r=>`<div class="card" style="background:#0e1124;border-color:#2f355e">
    <div class="chip">${r.platform}</div> <span class="chip">${r.handle||''}</span> <span class="chip">${r.postType}</span>
    <div class="divider"></div>
    <div class="mini"><strong>When:</strong> ${r.datetime? new Date(r.datetime).toLocaleString():'‚Äî'}</div>
    <div class="mini"><strong>Campaign:</strong> ${r.campaign||'‚Äî'}</div>
    <div class="mini"><strong>Reach:</strong> ${r.reach||0} ‚Ä¢ <strong>Engagements:</strong> ${r.engagements||0}</div>
    ${r.link? `<div class="links"><a href="${r.link}" target="_blank">Open post</a></div>`:''}
    ${r.notes? `<div class="mini">${r.notes}</div>`:''}
    <div class="mini">Logged by ${r.by} ‚Ä¢ ${new Date(r.ts).toLocaleString()}</div></div>`).join('') : '<div class="mini">No posts logged yet.</div>';
}

function buildBrand(){
  const c=$('#modBrand');
  c.innerHTML=`
    <div class="card" style="margin-top:18px;background:var(--accent4);color:#041d13">
      <h3>Branding Governance</h3>
      <div class="grid grid-3">
        <div><label>USACE Brand Guide URL</label><input id="brandGuide" class="input" placeholder="https://‚Ä¶"></div>
        <div><label>.mil Host / Site</label><input id="brandMil" class="input" placeholder="https://www.nww.usace.army.mil/‚Ä¶"></div>
        <div><label>Approvals Required (comma‚Äësep)</label><input id="brandApprovals" class="input" placeholder="PAO Release, OPSEC II, VI Caption, Accessibility, Records"></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:10px"><button class="cta" id="btnBrandSave">Save Policy</button></div>
    </div>
    <div class="card" style="margin-top:12px;background:var(--accent1);color:#06131a">
      <h3>Channel Inventory</h3>
      <div class="grid grid-3">
        <div><label>Site / Channel</label><input id="invName" class="input" placeholder="Facebook Page / Website section / DVIDS hub"></div>
        <div><label>URL</label><input id="invUrl" class="input" placeholder="https://‚Ä¶"></div>
        <div><label>Owner</label><input id="invOwner" class="input" placeholder="PAO / Section / POC"></div>
        <div><label>Authorized?</label><select id="invAuth" class="input"><option>Yes</option><option>No</option><option>Unknown</option></select></div>
        <div class="grid" style="grid-template-columns:1fr auto; align-items:end; gap:10px">
          <div><label>Notes</label><input id="invNotes" class="input" placeholder="Branding issues, migration, redirects‚Ä¶"></div>
          <button class="cta" id="btnInvAdd">Add</button>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:12px"><h3>Inventory</h3><div id="brandInvList" class="scroll"></div></div>`;
  $('#brandGuide').value=db.brand.policy.brandGuideUrl||''; $('#brandMil').value=db.brand.policy.milHost||''; $('#brandApprovals').value=(db.brand.policy.approvalsRequired||[]).join(', ');
  $('#btnBrandSave').onclick=()=>{ db.brand.policy.brandGuideUrl=$('#brandGuide').value.trim(); db.brand.policy.milHost=$('#brandMil').value.trim(); db.brand.policy.approvalsRequired=$('#brandApprovals').value.split(',').map(s=>s.trim()).filter(Boolean); save(); alert('Brand policy saved'); };
  $('#btnInvAdd').onclick=()=>{ const rec={id:uid(), siteOrChannel:$('#invName').value.trim(), url:$('#invUrl').value.trim(), owner:$('#invOwner').value.trim(), authorized:$('#invAuth').value, notes:$('#invNotes').value.trim(), ts:Date.now()}; if(!rec.siteOrChannel) return alert('Enter a site/channel'); db.brand.inventory.push(rec); save(); renderBrandInv(); $('#invName').value=''; $('#invUrl').value=''; $('#invOwner').value=''; $('#invNotes').value=''; };
  renderBrandInv();
}
function renderBrandInv(){
  const wrap=$('#brandInvList'); const rows=[...db.brand.inventory].sort((a,b)=>b.ts-a.ts);
  wrap.innerHTML = rows.length? rows.map(r=>`<div class="card" style="background:#0e1124;border-color:#2f355e"><div class="chip">${r.siteOrChannel}</div> <span class="chip">${r.authorized}</span>${r.url? `<div class="links"><a href="${r.url}" target="_blank">${r.url}</a></div>`:''}<div class="mini">Owner: ${r.owner||'‚Äî'}</div>${r.notes? `<div class="mini">${r.notes}</div>`:''}<div class="mini">${new Date(r.ts).toLocaleString()}</div></div>`).join('') : '<div class="mini">No inventory yet.</div>';
}

function buildChecklist(){
  const c=$('#modChecklist'); const approvals=db.brand.policy.approvalsRequired?.length? db.brand.policy.approvalsRequired.join(', ') : 'PAO Release, OPSEC II, VI Caption, Accessibility, Records';
  c.innerHTML=`
    <div class="card" style="margin-top:18px;background:var(--accent2);color:#1d0c16">
      <h3>Pre‚ÄëRelease Checklist (OPSEC ‚Ä¢ VI ‚Ä¢ Release)</h3>
      <div class="mini">Required approvals: ${approvals}</div>
      <div class="grid grid-3" style="margin-top:8px">
        <div><label>Product Title</label><input id="chkTitle" class="input" placeholder="e.g., Water Safety News Release"></div>
          <div><label>Product Type</label><select id="chkType" class="input">${getOutputNames().map(n=>`<option>${n}</option>`).join('')}<option>Other</option></select></div>
        <div><label>Links (comma or new line)</label><input id="chkLinks" class="input" placeholder="Drafts, assets, DVIDS, etc."></div>
      </div>
      <div class="grid grid-2" style="margin-top:12px">
        <div class="card" style="background:#0e1124;border-color:#2f355e"><h3>OPSEC / PII</h3>
          <div><label><input type="checkbox" id="opsecOk"> OPSEC reviewed (Level II)</label></div>
          <div class="grid grid-3"><div><label>Reviewer</label><input id="opsecRev" class="input" placeholder="Name"></div><div><label>Date</label><input id="opsecDate" class="input" type="date" value="${todayISO()}"></div><div><label>PII scrubbed?</label><select id="piiOk" class="input"><option>Yes</option><option>No</option></select></div></div>
        </div>
        <div class="card" style="background:#0e1124;border-color:#2f355e"><h3>VI Standards</h3>
          <div class="grid grid-3"><div><label>Captions complete?</label><select id="viCap" class="input"><option>Yes</option><option>No</option></select></div><div><label>Metadata embedded?</label><select id="viMeta" class="input"><option>Yes</option><option>No</option></select></div><div><label>Archived to DVIDS/CORE?</label><select id="viArch" class="input"><option>Yes</option><option>No</option></select></div></div>
        </div>
        <div class="card" style="background:#0e1124;border-color:#2f355e"><h3>Accessibility</h3>
          <div class="grid grid-3"><div><label>ALT text present?</label><select id="accAlt" class="input"><option>Yes</option><option>No</option></select></div><div><label>Captions / transcripts?</label><select id="accCap" class="input"><option>Yes</option><option>No</option></select></div><div><label>Readable (contrast/size)?</label><select id="accRead" class="input"><option>Yes</option><option>No</option></select></div></div>
        </div>
        <div class="card" style="background:#0e1124;border-color:#2f355e"><h3>Release & Records</h3>
          <div class="grid grid-3"><div><label>Release authority</label><input id="relAuth" class="input" placeholder="PAO / Commander"></div><div><label>Release date</label><input id="relDate" class="input" type="date" value="${todayISO()}"></div><div><label>Records tagged?</label><select id="recTag" class="input"><option>Yes</option><option>No</option></select></div></div>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:12px"><button class="cta" id="btnChkSave">Save Checklist</button><button class="ghost btn" id="btnChkReady">Mark Ready for Release</button></div>
    </div>
    <div class="card" style="margin-top:12px"><h3>Checklists</h3><div id="chkList" class="scroll"></div></div>`;
  $('#btnChkSave').onclick=()=> saveChecklist('Needs Fix'); $('#btnChkReady').onclick=()=> saveChecklist('Ready'); renderChecklist();
}
function saveChecklist(status){
  if(!user) return alert('Sign in');
  const rec={ id:uid(), by:user.name, title:$('#chkTitle').value.trim(), productType:$('#chkType').value, links:parseLinks($('#chkLinks').value),
    opsec:{checked:$('#opsecOk').checked, reviewer:$('#opsecRev').value.trim(), date:$('#opsecDate').value},
    pii:{checked:($('#piiOk').value==='Yes')}, vi:{caption:($('#viCap').value==='Yes'), metadata:($('#viMeta').value==='Yes'), archived:($('#viArch').value==='Yes')},
    accessibility:{alt:($('#accAlt').value==='Yes'), captions:($('#accCap').value==='Yes'), readable:($('#accRead').value==='Yes')},
    release:{authority:$('#relAuth').value.trim(), date:$('#relDate').value}, records:{tagged:($('#recTag').value==='Yes')},
    status, ts:Date.now() };
  if(status==='Ready'){ const ok=rec.opsec.checked && rec.pii.checked && rec.vi.caption && rec.vi.metadata && rec.accessibility.alt && rec.release.authority && rec.records.tagged; if(!ok) return alert('To mark Ready: OPSEC, PII, VI caption+metadata, ALT text, Release authority, and Records tag must be set.'); }
  db.checklists.push(rec); save(); renderChecklist(); alert('Checklist saved');
}
function renderChecklist(){
  const wrap=$('#chkList'); const rows=[...db.checklists].sort((a,b)=>b.ts-a.ts);
  wrap.innerHTML = rows.length? rows.map(r=>{ const flags=[ r.opsec.checked?'OPSEC‚úì':'OPSEC‚úó', r.pii.checked?'PII‚úì':'PII‚úó', r.vi.caption?'CAP‚úì':'CAP‚úó', r.vi.metadata?'META‚úì':'META‚úó', r.accessibility.alt?'ALT‚úì':'ALT‚úó', r.records.tagged?'REC‚úì':'REC‚úó' ].join(' ‚Ä¢ ');
    return `<div class="card" style="background:#0e1124;border-color:#2f355e"><div class="chip">${r.status}</div> <span class="chip">${r.productType}</span> <span class="chip">${r.title||'Untitled'}</span><div class="divider"></div><div class="mini">${flags}</div>${r.links?.length? `<div class="links" style="margin-top:6px">${r.links.map(u=>`<a href="${u}" target="_blank">${u}</a>`).join('<br>')}</div>`:''}<div class="mini">By ${r.by} ‚Ä¢ ${new Date(r.ts).toLocaleString()}</div></div>`; }).join('') : '<div class="mini">No checklists yet.</div>';
}

/* ================= ONBOARDING ================= */
function startOnboard(){
  if(localStorage.getItem(ONBOARD_KEY)) return;
  onboardOverlay.classList.remove('hidden');
  document.body.classList.add('noscroll');
  curStep=0;
  showStep(curStep);
}
function showStep(i){
  const step=steps[i];
  if(!step){ closeOnboard(true); return; }
  const el=document.getElementById(step.id);
  if(!el) return;
  const r=el.getBoundingClientRect();
  onboardSpotlight.style.top=r.top+'px';
  onboardSpotlight.style.left=r.left+'px';
  onboardSpotlight.style.width=r.width+'px';
  onboardSpotlight.style.height=r.height+'px';
  onboardText.textContent=step.text;
  onboardPrev.style.display=i===0?'none':'';
  onboardNext.textContent=i===steps.length-1?'Done':'Next';
}
function closeOnboard(fin){
  onboardOverlay.classList.add('hidden');
  document.body.classList.remove('noscroll');
  if(fin || onboardSkip.checked) localStorage.setItem(ONBOARD_KEY,'1');
}
onboardNext.addEventListener('click',()=>{
  curStep++;
  if(curStep>=steps.length) closeOnboard(true); else showStep(curStep);
});
onboardPrev.addEventListener('click',()=>{ if(curStep>0){ curStep--; showStep(curStep); } });
document.addEventListener('keydown',e=>{ if(e.key==='Escape') closeOnboard(); });
window.addEventListener('resize',()=>{ if(!onboardOverlay.classList.contains('hidden')) showStep(curStep); });
let onboardScrollPending=false;
window.addEventListener('scroll',()=>{
  if(onboardScrollPending) return;
  onboardScrollPending=true;
  requestAnimationFrame(()=>{
    onboardScrollPending=false;
    if(!onboardOverlay.classList.contains('hidden')) showStep(curStep);
  });
});

window.addEventListener('message', e=>{
  if(e.data?.type==='rpieOutputs' && Array.isArray(e.data.outputs)){
    if(!user) return;
    e.data.outputs.forEach(prod=>{
      db.entries.push({id:uid(), userId:user.id, type:'output', tf:cur.tf, tfKey:cur.key, ts:Date.now(), data:{product:prod, qty:1, links:[]}});
    });
    save();
    refreshStaff();
    refreshViewerIf();
  }
});

/* ================= INIT ================= */
(function init(){
  show('unit');
  // Viewer picker default
  if(tfViewerSel){ buildTfPicker(tfViewerPick, tfViewerSel.value, key=>{cur.key=key; refreshViewer();}); }
  startOnboard();
})();
</script>

<!-- Ask AI Module -->
<div id="askAIModule" class="card hide" style="margin-top:16px; max-width:600px; margin-left:auto; margin-right:auto;">
  <h3>Ask AI</h3>
  <div><label>Provider</label>
    <select id="aiProvider" class="input" style="margin-bottom:6px">
      <option value="openai">OpenAI</option>
      <option value="gemini">Gemini</option>
      <option value="camogpt">CamoGPT</option>
      <option value="asksage">AskSage</option>
    </select>
  </div>
  <textarea id="aiPrompt" rows="3" class="input" placeholder="Ask a question..."></textarea>
  <div style="margin-top:10px; display:flex; gap:10px;">
    <button class="cta" onclick="callAI()">Ask</button>
  </div>
  <pre id="aiOutput" class="mini" style="margin-top:10px; white-space:pre-wrap"></pre>
</div>

<script>
const aiPromptEl=document.getElementById('aiPrompt');
const aiProviderEl=document.getElementById('aiProvider');
const aiOutputEl=document.getElementById('aiOutput');
async function callAI(){
  const prompt=aiPromptEl.value.trim();
  const provider=aiProviderEl.value;
  if(!prompt) return alert('Enter a prompt first.');
  try{
    if (!window.PAOWeb) throw new Error('PAOWeb module not loaded');
    const data = await window.PAOWeb.askAi({ provider, prompt });
    aiOutputEl.textContent =
      data.result ||
      data.answer ||
      data.output ||
      data.choices?.[0]?.message?.content ||
      'No response';
  }catch(err){
    aiOutputEl.textContent='Error: '+err.message;
  }
}
</script>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm";

  const supabase = createClient(
    "https://lhzqrgqpkjdjlrwwvpqh.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxoenFyZ3Fwa2pkamxyd3d2cHFoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY2NDk4NzEsImV4cCI6MjA3MjIyNTg3MX0.YKglQntWyAz5tgJMqhimeVg1n532FSi5Q2wVYru-XTc",
    { auth: { storage: sessionStorage, autoRefreshToken: true, persistSession: true } }
  );
  window.supabase = supabase;

  const $ = (id) => document.getElementById(id);
  const whoPill = $("whoPill");

  const IDLE_LIMIT = 30 * 60 * 1000;
  let idleTimer;
  function resetIdle(){
    clearTimeout(idleTimer);
    idleTimer = setTimeout(()=>{ supabase.auth.signOut(); window.show('unit'); }, IDLE_LIMIT);
  }
  ['mousemove','keydown','click','scroll'].forEach(evt=> window.addEventListener(evt, resetIdle));

  // Sign in
  window.nwwSignIn = async (email, password) => {
    email = (email || $("si-email").value).trim().toLowerCase();
    password = password || $("si-pass").value;
    const selectedRole = window.role;
    $("status").textContent = "Signing you in, please wait";
    const { error } = await supabase.auth.signInWithPassword({
      email,
      password,
      options: { shouldCreateUser: false }
    });
    if (error) {
      $("status").textContent = `Signin error: ${error.message}`;
      return;
    }
    $("status").textContent = "Signed in.";
    const prof = await refreshAuthUI();
    const r = prof?.role || selectedRole;
    window.role = r;
    if (prof?.email) {
      const labelMap = { admin: 'Admin', chief: 'PAO Chief', staff: 'Staff' };
      const label = labelMap[r] || (r ? r.charAt(0).toUpperCase() + r.slice(1) : 'User');
      whoPill.textContent = `${label} ‚Äî ${prof.email}`;
    }
    if (r === 'admin') { window.buildAdmin?.(); window.show('admin'); }
    else if (r === 'chief') { window.buildChief?.(); window.show('chief'); }
    else if (r === 'staff') { window.buildStaff?.(); window.show('staff'); }
  };

  window.nwwSignUp = async () => {
    const email = $("su-email").value.trim().toLowerCase();
    const password = $("su-pass").value;
    const confirm = $("su-confirm").value;
    let role = $("su-role").value || 'staff';
    if (!['staff', 'chief', 'admin'].includes(role)) role = 'staff';
    if (password !== confirm) {
      $("status").textContent = "Passwords do not match";
      return;
    }
    const displayName = email.split('@')[0];
    const { data, error } = await supabase.auth.signUp({
      email,
      password,
      options: { data: { display_name: displayName, full_name: displayName, role } }
    });
    $("status").textContent = error ? `Signup error: ${error.message}` : "Check email for confirmation.";
    if (!error) {
      const userId = data.user?.id;
      if (userId) {
        const { error: profileError } = await supabase
          .from("profiles")
          .upsert({ user_id: userId, role });
        if (profileError) console.warn("Profile role set failed:", profileError.message);
      }
      await refreshAuthUI();
    }
  };

  window.requestPasswordReset = async () => {
    const email = $("si-email").value;
    if (!email) { alert("Enter email to reset password"); return; }
    const { origin, pathname } = window.location;
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: origin + pathname
    });
    $("status").textContent = error ? `Reset error: ${error.message}` : "Check email for reset link";
  };

  window.finishPasswordReset = async () => {
    const pass = $("rp-new").value;
    const confirm = $("rp-confirm").value;
    if (pass !== confirm) { alert("Passwords do not match"); return; }
    const { error } = await supabase.auth.updateUser({ password: pass });
    $("status").textContent = error ? `Reset error: ${error.message}` : "Password updated";
    if (!error) { await supabase.auth.signOut(); window.show('unit'); }
  };

  async function refreshAuthUI() {
    const { data: { session } } = await supabase.auth.getSession();
    const authed = !!session?.user;
    document.body.classList.toggle("is-authed", authed);

    if (!authed) {
      document.body.classList.remove("is-admin");
      window.role = null;
      $("status").textContent = "Not signed in";
      clearTimeout(idleTimer);
      return null;
    }

    const uid = session.user.id;
    let { data: prof } = await supabase
      .from("profiles")
      .select("role, full_name, email")
      .eq("user_id", uid)
      .single();

    if (!prof) {
      const meta = session.user.user_metadata || {};
      prof = {
        role: meta.role || null,
        full_name: meta.full_name || meta.display_name || null,
        email: session.user.email
      };
    }

    window.role = prof.role || window.role;
    document.body.classList.toggle("is-admin", window.role === "admin");
    $("status").textContent = `Signed in as ${prof.email || session.user.email}`;
    window.user = {
      id: uid,
      email: prof.email || session.user.email,
      name: prof.full_name || prof.email || session.user.email
    };
    const labelMap = { admin: 'Register', chief: 'PAO Chief', staff: 'Staff' };
    const label = labelMap[window.role] || (window.role ? window.role.charAt(0).toUpperCase() + window.role.slice(1) : 'User');
    whoPill.textContent = `${label} ‚Äî ${prof.email || session.user.email}`;
    resetIdle();
    await window.loadEntriesFromSupabase?.();
    const authScreens = new Set(['staffAuth','chiefAuth','adminAuth','adminReset']);
    if (authScreens.has(window.currentScreen)) {
      if (window.role === 'admin') { window.buildAdmin?.(); window.show('admin'); }
      else if (window.role === 'chief') { window.buildChief?.(); window.show('chief'); }
      else if (window.role === 'staff') { window.buildStaff?.(); window.show('staff'); }
    }
    return prof;
  }

  supabase.auth.onAuthStateChange((event) => {
    if (event === 'PASSWORD_RECOVERY') { window.show('adminReset'); }
    refreshAuthUI();
  });
  refreshAuthUI();

  // Example: save an Output (wire to your existing buttons later)
  window.addOutput = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) { alert("Sign in first"); return; }
    const timeframe = getSelectedTimeframe();   // implement to read your UI
    const product  = getProductType();          // implement to read your UI
    const other    = getOtherProductType();     // optional
    const qty      = parseInt(getQuantity(), 10) || 1;
    const links    = getLinksTextarea();        // optional

    const { error } = await supabase.from("outputs").insert([{
      user_id: user.id, timeframe, product_type: product, other, quantity: qty, links
    }]);
    if (error) alert(error.message); else refreshOutputs();
  };

  window.refreshOutputs = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if (!user) return;
    const tf = getSelectedTimeframe();
    const { data } = await supabase.from("outputs")
      .select("*").eq("user_id", user.id).eq("timeframe", tf)
      .order("created_at", { ascending: false });
    renderOutputsList(data); // implement to draw into your UI
  };
</script>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="paoweb-supabase.js"></script>
</body>
</html>
